<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="wVZecs0Awis41AZhX45RBAUlyk3nnpoOkebdIemwhxQ" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>回测backtrader &mdash; Fulongのblog</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://mafulong.github.io/2022/11/03/%E5%9B%9E%E6%B5%8Bbacktrader/"><link rel="alternate" type="application/atom+xml" title="Fulongのblog" href="https://mafulong.github.io"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/favicon.ico"><meta property="og:title" content="回测backtrader"><meta name="keywords" content="logbook, mafulong"><meta name="og:keywords" content="logbook, mafulong"><meta name="description" content="回测backtrader"><meta name="og:description" content="回测backtrader"><meta property="og:url" content="https://mafulong.github.io/2022/11/03/%E5%9B%9E%E6%B5%8Bbacktrader/"><meta property="og:site_name" content="Fulongのblog"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2022-11-03"> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://mafulong.github.io/" title="Fulongのblog"><span class="octicon octicon-mark-github"></span> Fulongのblog</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://mafulong.github.io/" class=" site-header-nav-item" target="" title="Home">Home</a> <a href="https://mafulong.github.io/categories/" class=" site-header-nav-item" target="" title="Categories">Categories</a> <a href="https://mafulong.github.io/archives/" class=" site-header-nav-item" target="" title="Achieves">Achieves</a> <a href="https://mafulong.github.io/open-source" class=" site-header-nav-item" target="" title="Open-Source">Open-Source</a> <a href="https://mafulong.github.io/bookmark" class=" site-header-nav-item" target="" title="Bookmark">Bookmark</a> <a href="https://mafulong.github.io/about" class=" site-header-nav-item" target="" title="About">About</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="回测backtrader"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">回测backtrader</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2022/11/03 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://mafulong.github.io/categories/#Finance" title="Finance">Finance</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 26933 字，约 77 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h2 id="回测backtrader">回测backtrader</h2><p>参考资料</p><ul><li>https://github.com/WenmuZhou/crypto/blob/master/doc/backtrader/1%E3%80%81%E6%A6%82%E8%BF%B0.md</li><li>https://github.com/jrothschild33/learn_backtrader</li><li>https://www.wuzao.com/document/backtrader/order.html</li><li>strategy的所有可用方法: https://www.backtrader.com/docu/strategy/?h=getdata</li></ul><p>在 Backtrader 中，交易流程大致如下：</p><ul><li>step1：设置交易条件：初始资金、交易税费、滑点、成交量限制等；</li><li>step2：在 Strategy 策略逻辑中下达交易指令 buy、sell、close，或取消交易 cancel；</li><li>step3：Order 模块会解读交易订单，解读的信息将交由经纪商 Broker 模块处理；</li><li>step4：经纪商 Broker 会根据订单信息检查订单并确定是否接收订单；</li><li>step5：经纪商 Broker 接收订单后，会按订单要求撮合成交 trade，并进行成交结算；</li><li>step6：Order 模块返回经纪商 Broker 中的订单执行结果。</li></ul><h2 id="策略">策略</h2><p><a href="https://github.com/WenmuZhou/crypto/blob/master/doc/backtrader/3%E3%80%81%E7%AD%96%E7%95%A5%E7%AF%87.md">参考</a></p><p>  Strategy类的属性包含数据、cerebro实例、分析器、仓位等等。详细介绍如下</p><ul><li>env:<ul><li>策略生存的cerebro实例对象</li></ul></li><li>datas:<ul><li>加载的数据队列</li></ul></li><li>dnames:<ul><li>用数据名称访问数据的属性</li></ul></li><li>broker:<ul><li>经纪人</li></ul></li><li>stats:<ul><li>观察者队列</li></ul></li><li>analyzers:<ul><li>分析器队列</li></ul></li><li>position:<ul><li>data0的仓位，position中有两个重要的参数：size和price。size表示持仓量，price表示平均价格</li></ul></li></ul><p>self.broker有一些仓位的方法</p><p>  有关仓位的方法一共有6种，分别描述如下：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">getsizer</span><span class="o">()</span>
<span class="n">返回自动股本计算的</span> <span class="nc">Sizer</span> <span class="n">实例对象</span><span class="err">。</span>

<span class="nf">setsizer</span><span class="o">(</span><span class="n">sizer</span><span class="o">)</span>
<span class="n">替换默认的</span> <span class="nc">Sizer</span><span class="err">，</span><span class="n">允许使用自定义的股本计算逻辑</span><span class="err">。</span>

<span class="nf">getsizing</span><span class="o">(</span><span class="n">data</span><span class="k">=</span><span class="nc">None</span><span class="o">,</span> <span class="n">isbuy</span><span class="k">=</span><span class="nc">True</span><span class="o">)</span>
<span class="n">返回当前</span> <span class="nc">Sizer</span> <span class="n">实例计算出的股本</span><span class="err">。</span>

<span class="nf">getposition</span><span class="o">(</span><span class="n">data</span><span class="k">=</span><span class="nc">None</span><span class="o">,</span> <span class="n">broker</span><span class="k">=</span><span class="nc">None</span><span class="o">)</span>
<span class="n">返回指定经纪人和数据集上的当前仓位信息</span><span class="err">。</span>

<span class="nf">getpositionbyname</span><span class="o">(</span><span class="n">name</span><span class="k">=</span><span class="nc">None</span><span class="o">,</span> <span class="n">broker</span><span class="k">=</span><span class="nc">None</span><span class="o">)</span>
<span class="n">返回指定经纪人中指定名称的仓位信息</span><span class="err">。</span>

<span class="nf">getpositionsbyname</span><span class="o">(</span><span class="n">broker</span><span class="k">=</span><span class="nc">None</span><span class="o">)</span>
<span class="n">返回指定经纪人下的所有仓位信息</span><span class="err">。</span>
</code></pre></div></div><p>一些可override的方法以及一些交易方法</p><ul><li>通过 <code class="language-plaintext highlighter-rouge">notify_order(order)</code> 发出订单状态变化的通知。</li><li>通过 <code class="language-plaintext highlighter-rouge">notify_trade(trade)</code> 发出交易开始/更新/关闭的通知。 这个会在一个卖单成功后被调用， 落后于notify_order.</li><li>通过 <code class="language-plaintext highlighter-rouge">notify_cashvalue(cash, value)</code> 发出代理手中当前现金和资产的通知。</li><li>通过 <code class="language-plaintext highlighter-rouge">notify_fund(cash, value, fundvalue, shares)</code> 发出代理手中当前现金和资产，以及正在交易的资金和股票的通知。</li><li>通过 <code class="language-plaintext highlighter-rouge">notify_store(msg, *args, **kwargs)</code> 发出的事件通知（需要单独实现）。</li><li>在 <code class="language-plaintext highlighter-rouge">next</code> 方法中，<code class="language-plaintext highlighter-rouge">Strategy</code> 可以通过以下操作来尝试盈利：<ul><li>使用 <code class="language-plaintext highlighter-rouge">buy</code> 方法，来做多或者减少/关闭空头交易。</li><li>使用 <code class="language-plaintext highlighter-rouge">sell</code> 方法，来做空或者减少/关闭多头交易。</li><li>使用 <code class="language-plaintext highlighter-rouge">close</code> 方法，来关闭一个现有的交易。</li><li>使用 <code class="language-plaintext highlighter-rouge">cancel</code> 方法，来取消一个尚未执行的订单。</li><li>当调用 <code class="language-plaintext highlighter-rouge">buy</code> 和 <code class="language-plaintext highlighter-rouge">sell</code> 方法后，都会生成订单，并且返回一个 <code class="language-plaintext highlighter-rouge">order</code>（或者 <code class="language-plaintext highlighter-rouge">order</code> 子类）的实例，每个实例都包含有一个唯一的 <code class="language-plaintext highlighter-rouge">ref</code> 标识符，用于区分不同的 <code class="language-plaintext highlighter-rouge">order</code>。</li></ul></li></ul><p>资金管理</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">broker</span><span class="o">.</span><span class="py">getcash</span><span class="o">()</span> <span class="n">获取余额</span><span class="err">，</span><span class="n">不包含市值</span><span class="err">，</span><span class="n">只是现金</span> 
<span class="nv">broker</span><span class="o">.</span><span class="py">getvalue</span><span class="o">()</span> <span class="n">余额现金</span><span class="o">+</span><span class="n">市值</span>

<span class="k">#</span> <span class="n">在</span> <span class="nc">Strategy</span> <span class="n">中添加资金或获取当前资金</span>
<span class="nv">self</span><span class="o">.</span><span class="py">broker</span><span class="o">.</span><span class="py">add_cash</span><span class="o">(</span><span class="mi">10000</span><span class="o">)</span> <span class="k">#</span> <span class="n">正数表示增加资金</span>
<span class="nv">self</span><span class="o">.</span><span class="py">broker</span><span class="o">.</span><span class="py">add_cash</span><span class="o">(-</span><span class="mi">10000</span><span class="o">)</span> <span class="k">#</span> <span class="n">负数表示减少资金</span>
<span class="nv">self</span><span class="o">.</span><span class="py">broker</span><span class="o">.</span><span class="py">getcash</span><span class="o">()</span> <span class="k">#</span> <span class="n">获取当前可用资金</span>



<span class="k">class</span> <span class="nc">TestStrategy</span><span class="o">(</span><span class="nv">bt</span><span class="o">.</span><span class="py">Strategy</span><span class="o">)</span><span class="k">:</span>
    <span class="kt">def</span> <span class="kt">next</span><span class="o">(</span><span class="kt">self</span><span class="o">)</span><span class="kt">:</span>
        <span class="kt">print</span><span class="o">(</span><span class="kt">'当前可用资金'</span><span class="o">,</span> <span class="kt">self.broker.getcash</span><span class="o">())</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'当前总资</span><span class="n">产</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">broker</span><span class="o">.</span><span class="py">getvalue</span><span class="o">())</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'当前持仓</span><span class="n">量</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">broker</span><span class="o">.</span><span class="py">getposition</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">).</span><span class="py">size</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'当前持仓成</span><span class="n">本</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">broker</span><span class="o">.</span><span class="py">getposition</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">).</span><span class="py">price</span><span class="o">)</span>
        <span class="k">#</span> <span class="n">也可以直接获取持仓</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'当前持仓</span><span class="n">量</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">getposition</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">).</span><span class="py">size</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'当前持仓成</span><span class="n">本</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">getposition</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">).</span><span class="py">price</span><span class="o">)</span>
        <span class="k">#</span> <span class="n">注</span><span class="err">：</span><span class="nf">getposition</span><span class="o">()</span> <span class="n">需要指定具体的标的数据集</span>
</code></pre></div></div><p><strong>滑点管理</strong></p><p>在实际交易中，由于市场波动、网络延迟等原因，交易指令中指定的交易价格与实际成交价格会存在较大差别，出现滑点。为了让回测结果更真实，在交易前可以通过 brokers 设置滑点，滑点的类型有 2 种：<strong>百分比滑点和固定滑点</strong>。不论哪种设置方式，都是起到相同的作用：买入时，在指定价格的基础上提高实际买入价格；卖出时，在指定价格的基础上，降低实际卖出价格；买的 “更贵”，卖的 “更便宜” 。</p><p>注：在 Backtrader 中，如果同时设置了百分比滑点和固定滑点，前者的优先级高于后者，最终按百分比滑点的设置处理。</p><p><strong>交易时机管理</strong></p><p>对于交易订单生成和执行时间，Backtrader 默认是 “当日收盘后下单，次日以开盘价成交”，这种模式在回测过程中能有效避免使用未来数据。但对于一些特殊的交易场景，比如“all_in”情况下，当日所下订单中的数量是用当日收盘价计算的（总资金 / 当日收盘价），次日以开盘价执行订单时，如果开盘价比昨天的收盘价提高了，就会出现可用资金不足的情况。为了应对一些特殊交易场景，Backtrader 还提供了一些 cheating 式的交易时机模式：Cheat-On-Open 和 Cheat-On-Close。</p><p>Cheat-On-Open 是“当日下单，当日以开盘价成交”模式，在该模式下，Strategy 中的交易逻辑不再写在 next() 方法里，而是写在特定的 next_open()、nextstart_open() 、prenext_open() 函数中，具体设置可参考如下案例：</p><ul><li>方式1：bt.Cerebro(cheat_on_open=True)；</li><li>方式2：cerebro.broker.set_coo(True)；</li><li>方式3：BackBroker(coo=True)。</li></ul><p><strong>下单高级函数</strong></p><p>buy_bracket() 和 sell_bracket() 会一次性生成 3 个自定义类型的订单：主订单 main order、针对主订单的止损单 stop order、针对主订单的止盈单 limit order 。</p><p><strong>buy_bracket()</strong></p><p>buy_bracket() 用于long side 的交易场景，买入证券后，在价格下跌时，希望通过止损单卖出证券，限制损失；在价格上升时，希望通过限价单卖出证券，及时获利，通过 buy_bracket() 可以同时提交上述 3 个订单，而无需繁琐的调用 3 次常规交易函数。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 函数可用参数
buy_bracket(# 主订单的参数
            data=None, size=None, price=None,
            plimit=None,exectype=bt.Order.Limit,
            valid=None, tradeid=0,
            trailamount=None, trailpercent=None,
            oargs={},
            # 止损单的参数
            stopprice=None, stopexec=bt.Order.Stop, stopargs={},
            # 止盈单的参数
            limitprice=None, limitexec=bt.Order.Limit, limitargs={},
            **kwargs):......
</code></pre></div></div><p>Broker 在执行交易时，会根据执行流程给订单赋予不同的状态，不同阶段的订单状态可以通过Strategy 中定义 notify_order() 方法来捕获，从而进行自定义的处理，从下达交易指令到订单执行结束，订单可能会依次呈现如下状态：</p><ul><li>Order.Created：订单已被创建；</li><li>Order.Submitted：订单已被传递给经纪商 Broker；</li><li>Order.Accepted：订单已被经纪商接收；</li><li>Order.Partial：订单已被部分成交；</li><li>Order.Complete：订单已成交；</li><li>Order.Rejected：订单已被经纪商拒绝；</li><li>Order.Margin：执行该订单需要追加保证金，并且先前接受的订单已从系统中删除；</li><li>Order.Cancelled (or Order.Canceled)：确认订单已经被撤销；</li><li>Order.Expired：订单已到期，其已经从系统中删除 。</li></ul><p>上述状态的排列顺序依次为：</p><p>[‘Created’、’Submitted’、’Accepted’、’Partial’、’Completed’、’Canceled’、’Expired’、’Margin’、’Rejected’]，而 order.status 的取值对应上述专题的位置索引，如order.status==4，对应 ‘Completed’ 状态 。</p><h2 id="数据">数据</h2><p>Backtrader对数据进行了对齐处理，按照起始时间最大的开始截取。因为我们选股是根据不同股票同一天的数据进行对比的，因此多出的时间就没有意义。</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">取第一个数据集</span> <span class="n">可以下面3中方式</span><span class="err">。</span><span class="n">取不是第一个的数据集可以用后两种方式</span>

<span class="nv">self</span><span class="o">.</span><span class="py">data</span> <span class="k">=</span> <span class="nv">self</span><span class="o">.</span><span class="py">data0</span> <span class="k">=</span> <span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">[</span><span class="err">0</span><span class="o">]</span> <span class="n">其实就是add_data的顺序</span><span class="err">。</span><span class="n">自动加了alias</span>
</code></pre></div></div><p><strong>line</strong>. 一个data有多个line，类似列的概念。</p><p>以 <code class="language-plaintext highlighter-rouge">self.datas</code> 为例，调用语句可以写成如下形式：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">#</span> <span class="n">访问第一个数据集的</span> <span class="n">close</span> <span class="n">线</span>
<span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span> <span class="k">#</span> <span class="n">可省略</span> <span class="n">lines</span> <span class="n">简写成</span><span class="err">：</span><span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">.</span><span class="py">close</span>
<span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">.</span><span class="py">lines_close</span> <span class="k">#</span> <span class="n">可省略</span> <span class="n">lines</span> <span class="n">简写成</span><span class="err">：</span><span class="nv">self</span><span class="o">.</span><span class="py">data_close</span>
<span class="k">#</span> <span class="n">访问第二个数据集的</span> <span class="n">open</span> <span class="n">线</span>
<span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span> <span class="k">#</span> <span class="n">可省略</span> <span class="n">lines</span> <span class="n">简写成</span><span class="err">：</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">close</span>
<span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines_close</span> <span class="k">#</span> <span class="n">可省略</span> <span class="n">lines</span> <span class="n">简写成</span><span class="err">：</span><span class="nv">self</span><span class="o">.</span><span class="py">data1_close</span>
<span class="k">#</span> <span class="n">注</span><span class="err">：</span><span class="n">只有从</span> <span class="nv">self</span><span class="o">.</span><span class="py">datas</span> <span class="n">调用</span> <span class="n">line</span> <span class="n">时可以省略</span> <span class="n">lines</span><span class="err">，</span><span class="n">调用</span> <span class="n">indicators</span> <span class="n">中的</span> <span class="n">line</span> <span class="n">时不能省略</span>
</code></pre></div></div><p>推荐就用self.data[x].lines[y] 或者self.data[x].lines.close这样。 这样不会出错。</p><p>line上取某个值，索引注意 index 0是当前数据，index -1是昨天数据，这样依次递减。</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">今天收盘价</span>
 <span class="nv">self</span><span class="o">.</span><span class="py">datas</span><span class="o">[</span><span class="err">0</span><span class="o">].</span><span class="py">close</span>
<span class="n">等同于</span>
 <span class="nf">print</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">datas</span><span class="o">[</span><span class="err">0</span><span class="o">].</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="err">0</span><span class="o">])</span>

<span class="nv">self</span><span class="o">.</span><span class="py">dataclose</span><span class="o">[</span><span class="err">0</span><span class="o">]</span> <span class="k">#</span> <span class="n">当日的收盘价</span>
<span class="nv">self</span><span class="o">.</span><span class="py">dataclose</span><span class="o">[</span><span class="kt">-</span><span class="err">1</span><span class="o">]</span> <span class="k">#</span> <span class="n">昨天的收盘价</span>
<span class="nv">self</span><span class="o">.</span><span class="py">dataclose</span><span class="o">[</span><span class="kt">-</span><span class="err">2</span><span class="o">]</span> <span class="k">#</span> <span class="n">前天的收盘价</span>

</code></pre></div></div><p>获取 line 长度：</p><p>1、self.data0.buflen() 返回整条线的总长度，固定不变；</p><p>2、在 next() 中调用 len(self.data0)，返回的是当前已处理（已回测）的数据长度，会随着回测的推进动态增长。</p><p>datetime 线：</p><p>1、datetime 线中的时间点存的是数字形式的时间，可以通过 bt.num2date() 方法将其转为“xxxx-xx-xx xx:xx:xx”这种形式；</p><p>2、对 datetime 线进行索引时，xxx.date(X) 可以直接以“xxxx-xx-xx xx:xx:xx”的形式返回，X 就是索引位置，可以看做是传统 [X] 索引方式的改进版 。</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dt</span> <span class="k">=</span> <span class="n">dt</span> <span class="n">or</span> <span class="nv">self</span><span class="o">.</span><span class="py">datas</span><span class="o">[</span><span class="err">0</span><span class="o">].</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="nf">print</span><span class="o">('%</span><span class="n">s</span><span class="o">,</span> <span class="o">%</span><span class="n">s</span><span class="o">'</span> <span class="o">%</span> <span class="o">(</span><span class="nv">dt</span><span class="o">.</span><span class="py">isoformat</span><span class="o">(),</span> <span class="n">txt</span><span class="o">))</span>
</code></pre></div></div><p>params定义常量，可以这样的元组或者dict形式。 是Strategy的属性。访问时用self.params.xxx或者self.p.xxx来使用。</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">params</span> <span class="k">=</span> <span class="o">((</span><span class="s">"maperiod"</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span>
              <span class="o">(</span><span class="s">"bprint"</span><span class="o">,</span> <span class="nc">False</span><span class="o">),)</span>
</code></pre></div></div><p>获取某个数据集的列表，看都有哪些lines</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nf">print</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">datas</span><span class="o">[</span><span class="err">0</span><span class="o">].</span><span class="py">getlinealiases</span><span class="o">())</span>
<span class="n">example</span><span class="k">:</span> <span class="o">(</span><span class="kt">'close'</span><span class="o">,</span> <span class="kt">'low'</span><span class="o">,</span> <span class="ss">'hig</span><span class="n">h</span><span class="o">',</span> <span class="ss">'ope</span><span class="n">n</span><span class="o">',</span> <span class="ss">'volum</span><span class="n">e</span><span class="o">',</span> <span class="ss">'openinteres</span><span class="n">t</span><span class="o">',</span> <span class="ss">'datetim</span><span class="n">e</span><span class="o">')</span>
</code></pre></div></div><p>Backtrader 将数据表格的列拆成了一个个 line 线对象，一列→一个指标→该指标的时间序列→一条线 line。Backtrader 默认情况下要求导入的数据表格要包含 7 个字段：’datetime’、 ‘open’、 ‘high’、 ‘low’、 ‘close’、 ‘volume’、 ‘openinterest’ ，这 7 个字段序列就对应了 7 条 line 。其实给列赋予“线”的概念也很好理解，回测过程中用到的时间序列行情数据可视化后就是一条条曲线：close 曲线、 open 曲线、high 曲线 ……</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestStrategy</span><span class="o">(</span><span class="nv">bt</span><span class="o">.</span><span class="py">Strategy</span><span class="o">)</span><span class="k">:</span>
 
    <span class="kt">def</span> <span class="k">__</span><span class="kt">init__</span><span class="o">(</span><span class="kt">self</span><span class="o">)</span><span class="kt">:</span>
        <span class="kt">print</span><span class="o">(</span><span class="err">"</span><span class="kt">---------</span> <span class="kt">打印</span> <span class="kt">self</span> <span class="kt">策略本身的</span> <span class="kt">lines</span> <span class="kt">----------</span><span class="err">"</span><span class="o">)</span>
        <span class="kt">print</span><span class="o">(</span><span class="kt">self.lines.getlinealiases</span><span class="o">())</span>
        <span class="kt">print</span><span class="o">(</span><span class="err">"</span><span class="kt">---------</span> <span class="kt">打印</span> <span class="kt">self.datas</span> <span class="kt">第一个数据表格的</span> <span class="kt">lines</span> <span class="kt">----------</span><span class="err">"</span><span class="o">)</span>
        <span class="kt">print</span><span class="o">(</span><span class="kt">self.datas</span><span class="o">[</span><span class="err">0</span><span class="o">]</span><span class="kt">.lines.getlinealiases</span><span class="o">())</span>
        <span class="k">#</span> <span class="n">计算第一个数据集的s收盘价的20日均线</span><span class="err">，</span><span class="n">返回一个</span> <span class="nc">Data</span> <span class="n">feed</span>
        <span class="nv">self</span><span class="o">.</span><span class="py">sma</span> <span class="k">=</span> <span class="nv">bt</span><span class="o">.</span><span class="py">indicators</span><span class="o">.</span><span class="py">SimpleMovingAverage</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">datas</span><span class="o">[</span><span class="err">0</span><span class="o">].</span><span class="py">close</span><span class="o">,</span> <span class="n">period</span><span class="k">=</span><span class="mi">20</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"--------- 打印 indicators 对象的 lines ----------"</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">sma</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">getlinealiases</span><span class="o">())</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"---------- 直接打印 indicators 对象的所有 lines -------------"</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">sma</span><span class="o">.</span><span class="py">lines</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"---------- 直接打印 indicators 对象的第一条 lines -------------"</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">sma</span><span class="o">.</span><span class="py">lines</span><span class="o">[</span><span class="err">0</span><span class="o">])</span>
        
    <span class="k">def</span> <span class="nf">next</span><span class="o">(</span><span class="n">self</span><span class="o">)</span><span class="k">:</span>
        <span class="kt">print</span><span class="o">(</span><span class="kt">'验证索引位置为</span> <span class="err">6</span> <span class="kt">的线是不是</span> <span class="kt">datetime'</span><span class="o">)</span>
        <span class="kt">print</span><span class="o">(</span><span class="kt">bt.num2date</span><span class="o">(</span><span class="kt">self.datas</span><span class="o">[</span><span class="err">0</span><span class="o">]</span><span class="kt">.lines</span><span class="o">[</span><span class="err">6</span><span class="o">]</span><span class="err">[0]</span><span class="o">))</span>
        <span class="k">#</span> <span class="nf">num2date</span><span class="o">()</span> <span class="n">作用是将数字形式的时间转为</span> <span class="n">date</span> <span class="n">形式</span>
        
<span class="n">cerebro</span> <span class="k">=</span> <span class="nv">bt</span><span class="o">.</span><span class="py">Cerebro</span><span class="o">()</span>
<span class="n">st_date</span> <span class="k">=</span> <span class="nv">datetime</span><span class="o">.</span><span class="py">datetime</span><span class="o">(</span><span class="mi">2019</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
<span class="n">ed_date</span> <span class="k">=</span> <span class="nv">datetime</span><span class="o">.</span><span class="py">datetime</span><span class="o">(</span><span class="mi">2021</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">28</span><span class="o">)</span>
<span class="n">datafeed1</span> <span class="k">=</span> <span class="nv">bt</span><span class="o">.</span><span class="py">feeds</span><span class="o">.</span><span class="py">PandasData</span><span class="o">(</span><span class="n">dataname</span><span class="k">=</span><span class="n">data1</span><span class="o">,</span>
                                <span class="n">fromdate</span><span class="k">=</span><span class="n">st_date</span><span class="o">,</span>
                                <span class="n">todate</span><span class="k">=</span><span class="n">ed_date</span><span class="o">)</span>
<span class="nv">cerebro</span><span class="o">.</span><span class="py">adddata</span><span class="o">(</span><span class="n">datafeed1</span><span class="o">,</span> <span class="n">name</span><span class="o">='</span><span class="mf">600466.</span><span class="nc">SH</span><span class="o">')</span>
<span class="n">datafeed2</span> <span class="k">=</span> <span class="nv">bt</span><span class="o">.</span><span class="py">feeds</span><span class="o">.</span><span class="py">PandasData</span><span class="o">(</span><span class="n">dataname</span><span class="k">=</span><span class="n">data2</span><span class="o">,</span>
                                <span class="n">fromdate</span><span class="k">=</span><span class="n">st_date</span><span class="o">,</span>
                                <span class="n">todate</span><span class="k">=</span><span class="n">ed_date</span><span class="o">)</span>
<span class="nv">cerebro</span><span class="o">.</span><span class="py">adddata</span><span class="o">(</span><span class="n">datafeed2</span><span class="o">,</span> <span class="n">name</span><span class="o">='</span><span class="mf">603228.</span><span class="nc">SH</span><span class="o">')</span>
<span class="nv">cerebro</span><span class="o">.</span><span class="py">addstrategy</span><span class="o">(</span><span class="nc">TestStrategy</span><span class="o">)</span>
<span class="n">rasult</span> <span class="k">=</span> <span class="nv">cerebro</span><span class="o">.</span><span class="py">run</span><span class="o">()</span>

<span class="o">---------</span> <span class="n">打印</span> <span class="n">self</span> <span class="n">策略本身的</span> <span class="n">lines</span> <span class="o">----------</span>
<span class="o">(</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',)</span>
<span class="o">---------</span> <span class="n">打印</span> <span class="nv">self</span><span class="o">.</span><span class="py">datas</span> <span class="n">第一个数据表格的</span> <span class="n">lines</span> <span class="o">----------</span>
<span class="o">(</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="ss">'lo</span><span class="n">w</span><span class="o">',</span> <span class="ss">'hig</span><span class="n">h</span><span class="o">',</span> <span class="ss">'ope</span><span class="n">n</span><span class="o">',</span> <span class="ss">'volum</span><span class="n">e</span><span class="o">',</span> <span class="ss">'openinteres</span><span class="n">t</span><span class="o">',</span> <span class="ss">'datetim</span><span class="n">e</span><span class="o">')</span>
<span class="o">---------</span> <span class="n">打印</span> <span class="n">indicators</span> <span class="n">对象的</span> <span class="n">lines</span> <span class="o">----------</span>
<span class="o">(</span><span class="ss">'sm</span><span class="n">a</span><span class="o">',)</span>
<span class="o">----------</span> <span class="n">直接打印</span> <span class="n">indicators</span> <span class="n">对象的所有</span> <span class="n">lines</span> <span class="o">-------------</span>
<span class="o">&lt;</span><span class="nv">backtrader</span><span class="o">.</span><span class="py">lineseries</span><span class="o">.</span><span class="py">Lines_LineSeries_LineIterator_DataAccessor_IndicatorBase_Indicator_MovingAverageBase_MovingAverageSimple_SimpleMovingAverage</span> <span class="k">object</span> <span class="nc">at</span> <span class="mh">0x7fa883e4a470</span><span class="o">&gt;</span>
<span class="o">----------</span> <span class="n">直接打印</span> <span class="n">indicators</span> <span class="n">对象的第一条</span> <span class="n">lines</span> <span class="o">-------------</span>
<span class="o">&lt;</span><span class="nv">backtrader</span><span class="o">.</span><span class="py">linebuffer</span><span class="o">.</span><span class="py">LineBuffer</span> <span class="k">object</span> <span class="nc">at</span> <span class="mh">0x7fa883e4a2b0</span><span class="o">&gt;</span>
<span class="n">验证索引位置为</span> <span class="mi">6</span> <span class="n">的线是不是</span> <span class="n">datetime</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">29</span> <span class="mi">00</span><span class="k">:</span><span class="err">00</span><span class="kt">:</span><span class="err">00</span>
<span class="kt">验证索引位置为</span> <span class="err">6</span> <span class="kt">的线是不是</span> <span class="kt">datetime</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span> <span class="mi">00</span><span class="k">:</span><span class="err">00</span><span class="kt">:</span><span class="err">00</span>
<span class="kt">验证索引位置为</span> <span class="err">6</span> <span class="kt">的线是不是</span> <span class="kt">datetime</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="k">:</span><span class="err">00</span><span class="kt">:</span><span class="err">00</span>
<span class="kt">验证索引位置为</span> <span class="err">6</span> <span class="kt">的线是不是</span> <span class="kt">datetime</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="k">:</span><span class="err">00</span><span class="kt">:</span><span class="err">00</span>
<span class="kt">验证索引位置为</span> <span class="err">6</span> <span class="kt">的线是不是</span> <span class="kt">datetime</span>
<span class="mi">2019</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="k">:</span><span class="err">00</span><span class="kt">:</span><span class="err">00</span>
<span class="kt">......</span>




<span class="kt">class</span> <span class="kt">TestStrategy</span><span class="o">(</span><span class="kt">bt.Strategy</span><span class="o">)</span><span class="kt">:</span>
    <span class="kt">def</span> <span class="k">__</span><span class="kt">init__</span><span class="o">(</span><span class="kt">self</span><span class="o">)</span><span class="kt">:</span>
        <span class="kt">self.count</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">#</span> <span class="n">用于计算</span> <span class="n">next</span> <span class="n">的循环次数</span>
        <span class="k">#</span> <span class="n">打印数据集和数据集对应的名称</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"------------- init 中的索引位置-------------"</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"0 索引："</span><span class="o">,</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="ss">'clos</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="err">0</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"-1 索引："</span><span class="o">,</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(-</span><span class="mi">1</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="kt">-</span><span class="err">1</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"-2 索引"</span><span class="o">,</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(-</span><span class="mi">2</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="kt">-</span><span class="err">2</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"1 索引："</span><span class="o">,</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="err">1</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"2 索引"</span><span class="o">,</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="err">2</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"从 0 开始往前取3天的收盘价："</span><span class="o">,</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="k">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"从-1开始往前取3天的收盘价："</span><span class="o">,</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="o">=-</span><span class="mi">1</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"从-2开始往前取3天的收盘价："</span><span class="o">,</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="o">=-</span><span class="mi">2</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"line的总长度："</span><span class="o">,</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">buflen</span><span class="o">())</span>
        
    <span class="k">def</span> <span class="nf">next</span><span class="o">(</span><span class="n">self</span><span class="o">)</span><span class="k">:</span>
        <span class="kt">print</span><span class="o">(</span><span class="kt">f</span><span class="err">"</span><span class="kt">-------------</span> <span class="kt">next</span> <span class="kt">的第</span><span class="o">{</span><span class="kt">self.count+</span><span class="err">1</span><span class="o">}</span><span class="kt">次循环</span> <span class="kt">--------------</span><span class="err">"</span><span class="o">)</span>
        <span class="kt">print</span><span class="o">(</span><span class="err">"</span><span class="kt">当前时点</span><span class="err">（</span><span class="kt">今日</span><span class="err">）："</span><span class="o">,</span><span class="kt">'datetime'</span><span class="o">,</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="err">0</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"往前推1天（昨日）："</span><span class="o">,</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(-</span><span class="mi">1</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="kt">-</span><span class="err">1</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"往前推2天（前日）"</span><span class="o">,</span> <span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(-</span><span class="mi">2</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="kt">-</span><span class="err">2</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"前日、昨日、今日的收盘价："</span><span class="o">,</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="k">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"往后推1天（明日）："</span><span class="o">,</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="err">1</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"往后推2天（明后日）"</span><span class="o">,</span> <span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">close</span><span class="o">[</span><span class="err">2</span><span class="o">])</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"已处理的数据点："</span><span class="o">,</span> <span class="nf">len</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">data1</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"line的总长度："</span><span class="o">,</span> <span class="nv">self</span><span class="o">.</span><span class="py">data0</span><span class="o">.</span><span class="py">buflen</span><span class="o">())</span>
        <span class="nv">self</span><span class="o">.</span><span class="py">count</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div><p>https://www.cnblogs.com/sidianok/p/13554909.html</p><ul><li><p>__init__里任何操作line的数据都会生成一个新的line， 并在next调用前更新完成。</p></li><li><p>next里函数会读取这个line， 默认就是读line[0]的数据</p></li></ul><p><strong>init() 中：</strong></p><p>访问的是整条 line，索引编号也是对整条 line 上所有数据点进行编号的，所以 0 号位置对应导入的行情数据中最晚的那个时间点 2021-01-28，然后依次 backwards；</p><p>通过 get() 切片时，如果是从 ago=0 开始取，不会返回数据，从其他索引位置开始取，能返回数据 。</p><p><strong>next()中</strong></p><p>在 next() 中，只要记住 0 是当前回测的时间点（今日），然后站在当前时刻回首过往：-1 是昨日、-2 是前日，依次类推 ；或者站在当前时刻期盼未来：1 是明日、2 是明后日，以此类推 。</p><p><strong>数据扩展</strong></p><p>在回测时，除了常规的高开低收成交量这些行情数据外，还会用到别的指标，比如选股回测时会用到很多选股因子（PE、PB 、PCF、……），那这些数据又该如何添加进 Backtrader 的数据表格呢？往 Backtrader 的数据表格里添加指标，就是给数据表格新增列，也就是给数据表格新增 line：以导入 DataFrame 为例，在继承原始的数据读取类 bt.feeds.PandasData 的基础上，设置 lines 属性和 params 属性，新的 line 会按其在 lines 属性中的顺序依次添加进数据表格中，具体对照下面例子的输出部分：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PandasData_more</span><span class="o">(</span><span class="nv">bt</span><span class="o">.</span><span class="py">feeds</span><span class="o">.</span><span class="py">PandasData</span><span class="o">)</span><span class="k">:</span>
    <span class="kt">lines</span> <span class="o">=</span> <span class="o">(</span><span class="ss">'p</span><span class="n">e</span><span class="o">',</span> <span class="ss">'p</span><span class="n">b</span><span class="o">',</span> <span class="o">)</span> <span class="k">#</span> <span class="n">要添加的线</span>
    <span class="k">#</span> <span class="n">设置</span> <span class="n">line</span> <span class="n">在数据源上的列位置</span>
    <span class="n">params</span><span class="o">=(</span>
        <span class="o">(</span><span class="ss">'p</span><span class="n">e</span><span class="o">',</span> <span class="o">-</span><span class="mi">1</span><span class="o">),</span>
        <span class="o">(</span><span class="ss">'p</span><span class="n">b</span><span class="o">',</span> <span class="o">-</span><span class="mi">1</span><span class="o">),</span>
           <span class="o">)</span>
    <span class="k">#</span> <span class="o">-</span><span class="mi">1</span><span class="n">表示自动按列明匹配数据</span><span class="err">，</span><span class="nf">也可以设置为线在数据源中列的位置索引</span> <span class="o">((</span><span class="ss">'p</span><span class="n">e</span><span class="o">',</span><span class="mi">6</span><span class="o">),(</span><span class="ss">'p</span><span class="n">b</span><span class="o">',</span><span class="mi">7</span><span class="o">),)</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="o">(</span><span class="nv">bt</span><span class="o">.</span><span class="py">Strategy</span><span class="o">)</span><span class="k">:</span>
    <span class="kt">def</span> <span class="k">__</span><span class="kt">init__</span><span class="o">(</span><span class="kt">self</span><span class="o">)</span><span class="kt">:</span>
        <span class="kt">print</span><span class="o">(</span><span class="err">"</span><span class="kt">---------</span> <span class="kt">打印</span> <span class="kt">self.datas</span> <span class="kt">第一个数据表格的</span> <span class="kt">lines</span> <span class="kt">----------</span><span class="err">"</span><span class="o">)</span>
        <span class="kt">print</span><span class="o">(</span><span class="kt">self.data0.lines.getlinealiases</span><span class="o">())</span>
        <span class="kt">print</span><span class="o">(</span><span class="err">"</span><span class="kt">pe</span> <span class="kt">line:</span><span class="err">"</span><span class="o">,</span> <span class="kt">self.data0.lines.pe</span><span class="o">)</span>
        <span class="nf">print</span><span class="o">(</span><span class="s">"pb line:"</span><span class="o">,</span> <span class="nv">self</span><span class="o">.</span><span class="py">data0</span><span class="o">.</span><span class="py">lines</span><span class="o">.</span><span class="py">pb</span><span class="o">)</span>

<span class="n">data1</span><span class="o">[</span><span class="kt">'pe'</span><span class="o">]</span> <span class="k">=</span> <span class="mi">2</span> <span class="k">#</span> <span class="n">给原先的data1新增pe指标</span><span class="err">（</span><span class="n">简单的取值为2</span><span class="err">）</span>
<span class="n">data1</span><span class="o">[</span><span class="kt">'pb'</span><span class="o">]</span> <span class="k">=</span> <span class="mi">3</span> <span class="k">#</span> <span class="n">给原先的data1新增pb指标</span><span class="err">（</span><span class="n">简单的取值为3</span><span class="err">）</span>
<span class="k">#</span> <span class="n">导入的数据</span> <span class="n">data1</span> <span class="n">中</span>
<span class="n">cerebro</span> <span class="k">=</span> <span class="nv">bt</span><span class="o">.</span><span class="py">Cerebro</span><span class="o">()</span>
<span class="n">st_date</span> <span class="k">=</span> <span class="nv">datetime</span><span class="o">.</span><span class="py">datetime</span><span class="o">(</span><span class="mi">2019</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
<span class="n">ed_date</span> <span class="k">=</span> <span class="nv">datetime</span><span class="o">.</span><span class="py">datetime</span><span class="o">(</span><span class="mi">2021</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">28</span><span class="o">)</span>
<span class="n">datafeed1</span> <span class="k">=</span> <span class="nc">PandasData_more</span><span class="o">(</span><span class="n">dataname</span><span class="k">=</span><span class="n">data1</span><span class="o">,</span>
                            <span class="n">fromdate</span><span class="k">=</span><span class="n">st_date</span><span class="o">,</span>
                            <span class="n">todate</span><span class="k">=</span><span class="n">ed_date</span><span class="o">)</span>
<span class="nv">cerebro</span><span class="o">.</span><span class="py">adddata</span><span class="o">(</span><span class="n">datafeed1</span><span class="o">,</span> <span class="n">name</span><span class="o">='</span><span class="mf">600466.</span><span class="nc">SH</span><span class="o">')</span>
<span class="nv">cerebro</span><span class="o">.</span><span class="py">addstrategy</span><span class="o">(</span><span class="nc">TestStrategy</span><span class="o">)</span>
<span class="n">rasult</span> <span class="k">=</span> <span class="nv">cerebro</span><span class="o">.</span><span class="py">run</span><span class="o">()</span>

<span class="o">---------</span> <span class="n">打印</span> <span class="nv">self</span><span class="o">.</span><span class="py">datas</span> <span class="n">第一个数据表格的</span> <span class="n">lines</span> <span class="o">----------</span>
<span class="o">(</span><span class="ss">'clos</span><span class="n">e</span><span class="o">',</span> <span class="ss">'lo</span><span class="n">w</span><span class="o">',</span> <span class="ss">'hig</span><span class="n">h</span><span class="o">',</span> <span class="ss">'ope</span><span class="n">n</span><span class="o">',</span> <span class="ss">'volum</span><span class="n">e</span><span class="o">',</span> <span class="ss">'openinteres</span><span class="n">t</span><span class="o">',</span> <span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span> <span class="ss">'p</span><span class="n">e</span><span class="o">',</span> <span class="ss">'p</span><span class="n">b</span><span class="o">')</span>
<span class="n">pe</span> <span class="n">line</span><span class="k">:</span> <span class="kt">&lt;backtrader.linebuffer.LineBuffer</span> <span class="kt">object</span> <span class="kt">at</span> <span class="err">0</span><span class="kt">x7fc71f858250&gt;</span>
<span class="kt">pb</span> <span class="kt">line:</span> <span class="kt">&lt;backtrader.linebuffer.LineBuffer</span> <span class="kt">object</span> <span class="kt">at</span> <span class="err">0</span><span class="kt">x7fc71f8582b0&gt;</span>
</code></pre></div></div><h2 id="指标-indicator">指标 Indicator</h2><p>在编写策略时，除了常规的高开低收成交量等行情数据外，还会用到各式各样的指标（变量），比如宏观经济指标、基本面分析指标、技术分析指标、另类数据等等。Backtrader 大致有 2 种获取指标的方式：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. 直接通过 DataFeeds 模块导入已经计算好的指标，比如《数据篇》中的导入新增指标 PE、PB；
2. 在编写策略时调用 Indicators 指标模块临时计算指标，比如 5 日均线、布林带等 。
</code></pre></div></div><p><strong>建议在 __init__() 中提前计算指标</strong></p><p>Strategy 中的 <strong>init</strong>() 函数在回测过程中只会在最开始的时候调用一次，而 next() 会每个交易日依次循环调用多次，所以为了提高回测效率，建议先在 <strong>init</strong>() 中一次性计算好指标（甚至是交易信号），然后在 next() 中调用已经算好的指标，这样能有效避免指标的重复计算，提高回测运行速度。建议遵循“<strong>init</strong>() 负责指标计算，next() 负责指标调用”的原则。</p><p><em>当逻辑变得非常复杂并涉及多个操作时，通常最好将其封装在一个指示符中。</em></p><p><strong>计算指标时的各种简写形式</strong></p><p>调用 Indicators 模块的函数计算指标时，默认是对 self.datas 数据对象中的第一张表格中的第一条line （默认第一条line是 close line）计算相关指标。以计算 5 日均线为例，各种不同级别的简写方式都是默认基于收盘价 close 计算 5 日均线，所以返回的结果都是一致的：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="o">(</span><span class="nv">bt</span><span class="o">.</span><span class="py">Strategy</span><span class="o">)</span><span class="k">:</span>
    <span class="kt">def</span> <span class="k">__</span><span class="kt">init__</span><span class="o">(</span><span class="kt">self</span><span class="o">)</span><span class="kt">:</span>
        <span class="k">#</span> <span class="kt">最简方式</span><span class="err">：</span><span class="kt">直接省略指向的数据集</span>
        <span class="nv">self</span><span class="o">.</span><span class="py">sma1</span> <span class="k">=</span> <span class="nv">btind</span><span class="o">.</span><span class="py">SimpleMovingAverage</span><span class="o">(</span><span class="n">period</span><span class="k">=</span><span class="mi">5</span><span class="o">)</span>
        <span class="k">#</span> <span class="n">只指定第一个数据表格</span>
        <span class="nv">self</span><span class="o">.</span><span class="py">sma2</span> <span class="k">=</span> <span class="nv">btind</span><span class="o">.</span><span class="py">SMA</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">,</span> <span class="n">period</span><span class="k">=</span><span class="mi">5</span><span class="o">)</span>
        <span class="k">#</span> <span class="n">指定第一个数据表格的close</span> <span class="n">线</span>
        <span class="nv">self</span><span class="o">.</span><span class="py">sma3</span> <span class="k">=</span> <span class="nv">btind</span><span class="o">.</span><span class="py">SMA</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">data</span><span class="o">.</span><span class="py">close</span><span class="o">,</span> <span class="n">period</span><span class="k">=</span><span class="mi">5</span><span class="o">)</span>
        <span class="k">#</span> <span class="n">完整写法</span>
        <span class="nv">self</span><span class="o">.</span><span class="py">sma4</span> <span class="k">=</span> <span class="nv">btind</span><span class="o">.</span><span class="py">SMA</span><span class="o">(</span><span class="nv">self</span><span class="o">.</span><span class="py">datas</span><span class="o">[</span><span class="err">0</span><span class="o">].</span><span class="py">lines</span><span class="o">[</span><span class="err">0</span><span class="o">],</span> <span class="n">period</span><span class="k">=</span><span class="mi">5</span><span class="o">)</span>
        <span class="k">#</span> <span class="n">指标函数也支持简写</span> <span class="nc">SimpleMovingAverage</span> <span class="o">→</span> <span class="nc">SMA</span>
        
    <span class="k">def</span> <span class="nf">next</span><span class="o">(</span><span class="n">self</span><span class="o">)</span><span class="k">:</span>
        <span class="k">#</span> <span class="kt">提取当前时间点</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'datetim</span><span class="n">e</span><span class="o">',</span> <span class="nv">self</span><span class="o">.</span><span class="py">datas</span><span class="o">[</span><span class="err">0</span><span class="o">].</span><span class="py">datetime</span><span class="o">.</span><span class="py">date</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
        <span class="k">#</span> <span class="n">打印当日</span><span class="err">、</span><span class="n">昨日</span><span class="err">、</span><span class="n">前日的均线</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'sma</span><span class="mi">1</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">sma1</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="k">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'sma</span><span class="mi">2</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">sma2</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="k">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'sma</span><span class="mi">3</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">sma3</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="k">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
        <span class="nf">print</span><span class="o">(</span><span class="ss">'sma</span><span class="mi">4</span><span class="o">',</span><span class="nv">self</span><span class="o">.</span><span class="py">sma4</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">ago</span><span class="k">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="k">=</span><span class="mi">3</span><span class="o">))</span>
</code></pre></div></div><p><strong>好用的运算函数</strong></p><p>在计算指标或编写策略逻辑时，离不开算术运算、关系运算、逻辑运算、条件运算……，为了更好的适用于Backtrader 框架的语法规则，Backtrader 的开发者还对一些常用的运算符做了优化和改进，使用起来更简便高效：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Strategy</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span> <span class="o">=</span> <span class="n">btind</span><span class="p">.</span><span class="n">SimpleMovingAverage</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># 5日均线
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span> <span class="o">=</span> <span class="n">btind</span><span class="p">.</span><span class="n">SimpleMovingAverage</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 10日均线
</span>        <span class="c1"># bt.And 中所有条件都满足时返回 1；有一个条件不满足就返回 0
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">And</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">And</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="c1"># bt.Or 中有一个条件满足时就返回 1；所有条件都不满足时返回 0
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">Or</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Or</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="c1"># bt.If(a, b, c) 如果满足条件 a，就返回 b，否则返回 c
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">If</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="c1"># bt.All,同 bt.And
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">All</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="c1"># bt.Any，同 bt.Or
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">Any</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="c1"># bt.Max，返回同一时刻所有指标中的最大值
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">Max</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">)</span>
        <span class="c1"># bt.Min，返回同一时刻所有指标中的最小值
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">Min</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Min</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">)</span>
        <span class="c1"># bt.Sum，对同一时刻所有指标进行求和
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">Sum</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Sum</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">)</span>
        <span class="c1"># bt.Cmp(a,b), 如果 a&gt;b ，返回 1；否则返回 -1
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">Cmp</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Cmp</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'---------- datetime'</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">'------------------'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'close:'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">'ma5:'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">'ma10:'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'close&gt;ma5'</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">,</span> <span class="s">'close&gt;ma10'</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">,</span> <span class="s">'ma5&gt;ma10'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.And'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">And</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.Or'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">Or</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.If'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">If</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1000</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span> <span class="k">else</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.All'</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">All</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.Any'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">Any</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.Max'</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">Max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.Min'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">Min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.Sum'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">Sum</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma10</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">sma5</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'self.Cmp'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">Cmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="o">&gt;</span><span class="bp">self</span><span class="p">.</span><span class="n">sma5</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div><p><strong>如何对齐不同周期的指标</strong></p><p>通常情况下，操作的都是相同周期的数据，比如日度行情数据计算返回各类日度指标、周度行情数据计算返回各类周度指标、……，行情数据和指标的周期是一致的，时间也是对齐的。但有时候也会遇到操作不同周期数据的情况，比如拿日度行情与月度指标作比较，日度行情每天都有数据，而月度指标每个月只有一个，2 条数据在时间上是没有对齐的</p><p>可以使用“ ( ) ”语法操作来对齐不同周期的数据，对齐的方向是“大周期向小周期对齐”，可以选择指标对象中的某条 line 进行对齐，也可以对整个指标对象进行对齐。在使用该语法时，要将 cerebro.run() 中的 runonce 设置为 False，才能实现对齐操作：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># self.data0 是日度行情、self.data1 是月度行情
</span><span class="bp">self</span><span class="p">.</span><span class="n">month</span> <span class="o">=</span> <span class="n">btind</span><span class="p">.</span><span class="n">xxx</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data1</span><span class="p">)</span> <span class="c1"># 计算返回的 self.month 指标也是月度的
# 选择指标对象中的第一条 line 进行对齐
</span><span class="bp">self</span><span class="p">.</span><span class="n">sellsignal</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">data0</span><span class="p">.</span><span class="n">close</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">month</span><span class="p">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]()</span>
<span class="c1"># 对齐整个指标对象
</span><span class="bp">self</span><span class="p">.</span><span class="n">month_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">month</span><span class="p">()</span>
<span class="bp">self</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">data0</span><span class="p">.</span><span class="n">close</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">month_</span><span class="p">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">cerebro</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">runonce</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div><p>“ ( ) ”语法类似于线的切片操作 get (ago=-1, size=1)，然后在更细的时间点上始终取当前最新的指标值。比如对于月度指标，向日度对齐时，月中的那些时间点的数据取得是当前最新的数据（即：月初的指标值），直到下个月月初新的指标值计算出来为止</p><p><strong>在 Backtrader 中调用 TA-Lib 库</strong></p><p>为了满足大家的使用习惯，Backtrader 还接入了 TA-Lib 技术指标库，具体信息可以查阅官方 document ：<em>https://www.backtrader.com/docu/talibindautoref/</em> ，文档中同样对各个函数的输入、输出，以及在 Backtrader 中特有的绘图参数、返回的 lines 属性等信息都做了介绍和说明。TA-Lib 指标函数的调用形式为 bt.talib.xxx ：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TALibStrategy</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 计算 5 日均线
</span>        <span class="n">bt</span><span class="p">.</span><span class="n">talib</span><span class="p">.</span><span class="n">SMA</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">close</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">bt</span><span class="p">.</span><span class="n">indicators</span><span class="p">.</span><span class="n">SMA</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># 计算布林带
</span>        <span class="n">bt</span><span class="p">.</span><span class="n">talib</span><span class="p">.</span><span class="n">BBANDS</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">bt</span><span class="p">.</span><span class="n">indicators</span><span class="p">.</span><span class="n">BollingerBands</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
</code></pre></div></div><p><strong>自定义新指标</strong></p><p>在 Backtrader 中，如果涉及到自定义操作，一般都是通过继承原始的父类，然后在新的子类里自定义属性，比如之前介绍的自定义数据读取函数 class My_CSVData (bt.feeds.GenericCSVData)，就是继承了原始GenericCSVData 类，自定义新指标也类似，需要继承原始的 bt.Indicator 类，然后在新的子类里构建指标。新的子类里通常可以设置如下属性：</p><ul><li>lines = (‘xxx’, ‘xxx’, ‘xxx’,)：定义指标函数返回的 lines 名称，方便后面通过名称调用具体的指标，如 self.lines.xxx、self.l.xxx、self.xxx；</li><li>params = ((‘xxx’, n),)：定义参数，方便在子类里全局调用，也方便在使用指标函数时修改参数取值；</li><li><strong>init</strong>() 方法：同策略 Strategy 里的 <strong>init</strong>() 类似，对整条 line 进行运算，运算结果也以整条 line 的形式返回；</li><li>next() 方法：同策略 Strategy 里的 next() 类似，每个 bar 都会运行一次，在 next() 中是对数据点进行运算；</li><li>once() 方法：这个方法只运行一次，但是需要从头到尾循环计算指标；</li><li>指标绘图相关属性的设置：例如：plotinfo = dict() 通过字典形式修改绘图参数；plotlines = dict() 设置曲线样式 等等，指标绘制相关内容会在后期的《可视化篇》进行重点讲解。</li><li>自定义指标时，建议首选 <strong>init</strong>()，因为 <strong>init</strong>() 最智能，能自动实现 next() 和 once() 的功能，计算指标一气呵成 。</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyInd</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Indicator</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="n">xxx</span><span class="p">,</span> <span class="p">)</span> <span class="c1"># 最后一个 “,” 别省略
</span>    <span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="n">xxx</span><span class="p">,</span> <span class="n">n</span><span class="p">),)</span> <span class="c1"># 最后一个 “,” 别省略
</span>    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''可选'''</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''可选'''</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">once</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''可选'''</span>
        <span class="k">pass</span> 
    
    <span class="n">plotinfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(...)</span>
    <span class="n">plotlines</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(...)</span>
    <span class="p">...</span>
</code></pre></div></div><p>下面是通过自定义指标复现 MACD 算法的例子，可以再具体的感受一下自定义指标的大致操作：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">My_MACD</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Indicator</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s">'macd'</span><span class="p">,</span> <span class="s">'signal'</span><span class="p">,</span> <span class="s">'histo'</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="s">'period_me1'</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span>
              <span class="p">(</span><span class="s">'period_me2'</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
              <span class="p">(</span><span class="s">'period_signal'</span><span class="p">,</span> <span class="mi">9</span><span class="p">),)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">me1</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">period_me1</span><span class="p">)</span>
        <span class="n">me2</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">period_me2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">macd</span> <span class="o">=</span> <span class="n">me1</span> <span class="o">-</span> <span class="n">me2</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">macd</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">period_signal</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">histo</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">macd</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">signal</span>
</code></pre></div></div><h2 id="策略2">策略2</h2><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653317634&amp;idx=1&amp;sn=e92fec0b0b5fd5f62805e7c2be5830f8&amp;chksm=802da817b75a2101c5812a6fc9daf0b2c08ce21d882bdd3059d2e9f391432b3ac9e950d5e151&amp;cur_album_id=2380299870701420545&amp;scene=189#wechat_redirect">参考</a></p><p><strong>基于交易信号直接生成策略</strong></p><p>除了在 Strategy 类中编写策略外，追求 “极简” 的 Backtrader 还给大家提供了一种更为简单的策略生成方式，这种方式不需要定义 Strategy 类，更不需要调用交易函数，只需计算信号 signal 指标，然后将其 add_signal 给大脑 Cerebro 即可，Cerebro 会自动将信号 signal 指标转换为交易指令，通常可以将这类策略称为信号策略 SignalStrategy 。下面以官方文档中的例子介绍信号策略生成方式：</p><ul><li><p>step1：自定义交易信号，交易信号和一般的指标相比的区别只在于：交易信号指标在通过 add_signal 传递给大脑后，大脑会将其转换为策略，所以在自定义交易信号时直接按照 Indicator 指标定义方式来定义即可（具体可以参考之前的《指标篇》）。定义时需要声明信号 ‘signal’ 线，信号指标也是赋值给 ‘signal’ 线；</p></li><li><p>step2：按常规方式，实例化大脑 cerebro、加载数据、通过 add_signal 添加交易信号线 ；</p></li><li><p>备注1：信号策略每次下单的成交量取的是 Sizer 模块中的 FixedSize，默认成交 1 单位的标的，比如 1 股、1 张合约等；</p></li><li><p>备注2：生成的是市价单 Market，订单在被取消前一直都有效。</p></li></ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import backtrader as bt

# 自定义信号指标
class MySignal(bt.Indicator):
    lines = ('signal',) # 声明 signal 线，交易信号放在 signal line 上
    params = (('period', 30),)

    def __init__(self):
        self.lines.signal = self.data - bt.indicators.SMA(period=self.p.period)

# 实例化大脑
cerebro = bt.Cerebro()
# 加载数据
data = bt.feeds.OneOfTheFeeds(dataname='mydataname')
cerebro.adddata(data)
# 添加交易信号
cerebro.add_signal(bt.SIGNAL_LONGSHORT, MySignal, period=xxx)
cerebro.run()
</code></pre></div></div><p>支持添加多条交易信号：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import backtrader as bt

# 定义交易信号1
class SMACloseSignal(bt.Indicator):
    lines = ('signal',)
    params = (('period', 30),)

    def __init__(self):
        self.lines.signal = self.data - bt.indicators.SMA(period=self.p.period)

# 定义交易信号2
class SMAExitSignal(bt.Indicator):
    lines = ('signal',)
    params = (('p1', 5), ('p2', 30),)

    def __init__(self):
        sma1 = bt.indicators.SMA(period=self.p.p1)
        sma2 = bt.indicators.SMA(period=self.p.p2)
        self.lines.signal = sma1 - sma2
        
# 实例化大脑
cerebro = bt.Cerebro()
# 加载数据
data = bt.feeds.OneOfTheFeeds(dataname='mydataname')
cerebro.adddata(data)
# 添加交易信号1
cerebro.add_signal(bt.SIGNAL_LONG, MySignal, period=xxx)
# 添加交易信号2
cerebro.add_signal(bt.SIGNAL_LONGEXIT, SMAExitSignal, p1=xxx, p2=xxx)
cerebro.run()
</code></pre></div></div><p><strong>信号指标取值与多空信号对应关系：</strong></p><ul><li>signal 指标取值大于0 → 对应多头 long 信号；</li><li>signal 指标取值小于0 → 对应空头 short 信号；</li><li>signal 指标取值等于0 → 不发指令；</li></ul><h2 id="plotting-不推荐">Plotting 不推荐</h2><p>cerebro.plot() 写在 cerebro.run() 后面，用于回测的可视化。总的来说，cerebro.plot() 支持回测如下 3 大内容：</p><ul><li>Data Feeds：即在回测开始前，通过 adddata、replaydata、resampledata 等方法导入大脑的原始数据；</li><li>Indicators ：即回测时构建的各类指标，比如在 strategy 中构建的指标、通过 addindicator 添加的；</li><li>Observers ：即上文介绍的观测器对象； <a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653317947&amp;idx=1&amp;sn=8422b62036c4a0693114f6b779fb9cde&amp;chksm=802da92eb75a20380ed04560bf2ed947d7879d5f0f806b094dccc30cc8de83e269c73c375931&amp;cur_album_id=2380299870701420545&amp;scene=189#wechat_redirect">参考</a></li><li>在绘制图形时，默认是将 Data Feeds 绘制在主图上；Indicators 有的与 Data Feeds 一起绘制在主图上，比如均线，有的以子图形式绘制；Observers 通常绘制在子图上。</li></ul><p>指标绘图</p><ul><li>Declared <code class="language-plaintext highlighter-rouge">Indicators</code> get automatically plotted (if cerebro.plot is called) init里声明的指标将自动绘制（如果cerebro.plot被调用）</li><li><strong>lines</strong> objects from operations DO NOT GET plotted (like <code class="language-plaintext highlighter-rouge">close_over_sma = self.data.close &gt; self.sma</code>) 不打印来自操作的<strong>lines</strong>对象。 Strategy里init里的line.</li><li>There is an auxiliary <code class="language-plaintext highlighter-rouge">LinePlotterIndicator</code> which plots such operations if wished with the following approach 有一个辅助的LinePlotterIndicator，可根据需要使用以下方法绘制这些操作：　可手动画图。</li></ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>close_over_sma = self.data.close &gt; self.sma
LinePlotterIndicator(close_over_sma, name='Close_over_SMA')
</code></pre></div></div><p>　name参数为该指示符保留的单行命名</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyIndicator</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Indicator</span><span class="p">):</span>
    <span class="c1"># 在lines里面声明指标的名称，使用时可以用self.lines.sma或者self.l.sma
</span>    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s">'sma'</span><span class="p">,</span> <span class="p">)</span>
    <span class="c1"># 相关参数
</span>    <span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="s">'period'</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">)</span>

    <span class="c1"># 如果指标可以一次性计算完，就可直接在__init__中完成计算；如果不能，就需要在next中计算，如果计算周期大于1，就需要加上addminperiod()方法，保证在next中计算时数据充足
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">addminperiod</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">period</span><span class="p">)</span>

    <span class="c1"># 每个bar运行一次
</span>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">datasum</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">fsum</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">period</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lines</span><span class="p">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">datasum</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">period</span>
</code></pre></div></div><p>上面是实现新指标计算的一般必须过程。在实现新指标过程中，也可以更改可视化的参数：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyIndicator</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Indicator</span><span class="p">):</span>
    <span class="c1"># 画图的设置，详细的在可视化中介绍
</span>    <span class="n">plotinfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">plotymargin</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
        <span class="n">plothlines</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
        <span class="n">plotyticks</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])</span>

    <span class="c1"># Plot the line "overunder" (the only one) with dash style
</span>    <span class="c1"># ls stands for linestyle and is directly passed to matplotlib
</span>    <span class="n">plotlines</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">overunder</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s">'--'</span><span class="p">))</span>

    <span class="c1"># 获取指标的名称列表
</span>    <span class="k">def</span> <span class="nf">_plotlabel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plabels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">period</span><span class="p">]</span>

        <span class="n">plabels</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">movav</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">notdefault</span><span class="p">(</span><span class="s">'movav'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">plabels</span>
</code></pre></div></div><p><a href="https://github.com/WenmuZhou/crypto/blob/master/doc/backtrader/8%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AF%87.md">参考</a></p><p> plot()函数原型如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plot(plotter=None, numfigs=1, iplot=True, start=None, end=None, width=16, height=9, dpi=300, tight=True, use=None, **kwargs)
</code></pre></div></div><ul><li>plotter：默认为None，画图的实例对象。如果为None，在plot()内用kwargs参数创建。</li><li>numfigs：多少张图。用时间进行划分，比如numfigs=2，时间是两年，每张图都只画出一年的图</li><li>iplot：如果为True，并且在notebook上运行，图形在行内显示</li><li>start：画图的起始时间</li><li>end：画图的结束时间</li><li>width：保存图像的宽度(inches)</li><li>height：保存图像的高度(inches)</li><li>dpi：分辨率</li><li>tight：仅仅保存实际内容</li><li>use：没有用到</li></ul><h2 id="分析器">分析器</h2><p>在 Backtrader 中，有专门负责回测收益评价指标计算的模块 analyzers，大家可以将其称为“策略分析器”。关于 analyzers 支持内置的指标分析器的具体信息可以参考官方文档 Backtrader ~ Analyzers Reference 。分析器的使用主要分为 2 步：</p><ul><li><p>第一步：通过 addanalyzer(ancls, _name, *args, **kwargs) 方法将分析器添加给大脑，ancls 对应内置的分析器类，后面是分析器各自支持的参数，添加的分析器类 ancls 在 cerebro running 区间会被实例化，并分配给 cerebro 中的每个策略，然后分析每个策略的表现，而不是所有策略整体的表现 ；</p></li><li><p>第二步：分别基于results = cerebro.run() 返回的各个对象 results[x] ，提取该对象 analyzers 属性下的各个分析器的计算结果，并通过 get_analysis() 来获取具体值。</p></li><li><p>说明：addanalyzer() 时，通常会通过 _name 参数对分析器进行命名，在第二步获取分析器结果就是通过_name 来提取的。</p></li></ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">......</span>
<span class="c1"># 添加分析指标
# 返回年初至年末的年度收益率
</span><span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">AnnualReturn</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_AnnualReturn'</span><span class="p">)</span>
<span class="c1"># 计算最大回撤相关指标
</span><span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">DrawDown</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_DrawDown'</span><span class="p">)</span>
<span class="c1"># 计算年化收益：日度收益
</span><span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">Returns</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_Returns'</span><span class="p">,</span> <span class="n">tann</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
<span class="c1"># 计算年化夏普比率：日度收益
</span><span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">SharpeRatio</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_SharpeRatio'</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="p">.</span><span class="n">TimeFrame</span><span class="p">.</span><span class="n">Days</span><span class="p">,</span> <span class="n">annualize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">riskfreerate</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 计算夏普比率
</span><span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">SharpeRatio_A</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_SharpeRatio_A'</span><span class="p">)</span>
<span class="c1"># 返回收益率时序
</span><span class="n">cerebro</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">TimeReturn</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_TimeReturn'</span><span class="p">)</span>
<span class="c1"># 启动回测
</span><span class="n">result</span> <span class="o">=</span> <span class="n">cerebro</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># 提取结果
</span><span class="k">print</span><span class="p">(</span><span class="s">"--------------- AnnualReturn -----------------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_AnnualReturn</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"--------------- DrawDown -----------------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_DrawDown</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"--------------- Returns -----------------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_Returns</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"--------------- SharpeRatio -----------------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_SharpeRatio</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"--------------- SharpeRatio_A -----------------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_SharpeRatio_A</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">())</span>
<span class="p">......</span>
</code></pre></div></div><p>各个分析器的结果通常以 OrderedDict 字典的形式返回，如下所示，大家可以通过 keys 取需要的 values：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AutoOrderedDict</span><span class="p">([(</span><span class="s">'len'</span><span class="p">,</span> <span class="mi">56</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">'drawdown'</span><span class="p">,</span> <span class="mf">8.085458202746946e-05</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">'moneydown'</span><span class="p">,</span> <span class="mf">8.08547225035727</span><span class="p">),</span>
                 <span class="p">(</span><span class="s">'max'</span><span class="p">,</span>
                  <span class="n">AutoOrderedDict</span><span class="p">([(</span><span class="s">'len'</span><span class="p">,</span> <span class="mi">208</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s">'drawdown'</span><span class="p">,</span> <span class="mf">0.00015969111320873712</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s">'moneydown'</span><span class="p">,</span> <span class="mf">15.969112889841199</span><span class="p">)]))])</span>

<span class="c1"># 常用指标提取
</span><span class="n">analyzer</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># 提取年化收益
</span><span class="n">analyzer</span><span class="p">[</span><span class="s">'年化收益率'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_Returns</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'rnorm'</span><span class="p">]</span>
<span class="n">analyzer</span><span class="p">[</span><span class="s">'年化收益率（%）'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_Returns</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'rnorm100'</span><span class="p">]</span>
<span class="c1"># 提取最大回撤
</span><span class="n">analyzer</span><span class="p">[</span><span class="s">'最大回撤（%）'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_DrawDown</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'max'</span><span class="p">][</span><span class="s">'drawdown'</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># 提取夏普比率
</span><span class="n">analyzer</span><span class="p">[</span><span class="s">'年化夏普比率'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_SharpeRatio_A</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'sharperatio'</span><span class="p">]</span>

<span class="c1"># 日度收益率序列
</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_TimeReturn</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">())</span>
</code></pre></div></div><p>除了上面提到的这些内置分析器外，Backtrader 当然还支持自定义分析器（不然就不符合 Backtrader style 了）。凡是涉及到自定义的操作，遵循的都是“在继承了 xxx 原始父类的基础上，在新的子类里自定义相关属性和方法”，分析器毕竟是用来分析整个回测的，既涉及过程，又涉及结果，所以继承的 bt.Analyzer 父类中的方法和相应的运行逻辑和策略中的基本一致：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="n">bt</span> <span class="c1"># 导入 Backtrader
</span>    
<span class="c1"># 官方提供的 SharpeRatio 例子
</span><span class="k">class</span> <span class="nc">SharpeRatio</span><span class="p">(</span><span class="n">Analyzer</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="s">'timeframe'</span><span class="p">,</span> <span class="n">TimeFrame</span><span class="p">.</span><span class="n">Years</span><span class="p">),</span> <span class="p">(</span><span class="s">'riskfreerate'</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SharpeRatio</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">anret</span> <span class="o">=</span> <span class="n">AnnualReturn</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Not needed ... but could be used
</span>        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Not needed ... but could be used
</span>        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retfree</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">riskfreerate</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">anret</span><span class="p">.</span><span class="n">rets</span><span class="p">)</span>
        <span class="n">retavg</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="p">.</span><span class="n">sub</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">anret</span><span class="p">.</span><span class="n">rets</span><span class="p">,</span> <span class="n">retfree</span><span class="p">)))</span>
        <span class="n">retdev</span> <span class="o">=</span> <span class="n">standarddev</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">anret</span><span class="p">.</span><span class="n">rets</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">retavg</span> <span class="o">/</span> <span class="n">retdev</span>
        
    <span class="k">def</span> <span class="nf">get_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sharperatio</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ratio</span><span class="p">)</span>
      
      
<span class="n">例子2</span>

<span class="k">class</span> <span class="nc">trade_list</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Analyzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cumprofit</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">notify_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">trade</span><span class="p">.</span><span class="n">isclosed</span><span class="p">:</span>
            <span class="n">brokervalue</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">strategy</span><span class="p">.</span><span class="n">broker</span><span class="p">.</span><span class="n">getvalue</span><span class="p">()</span>

            <span class="nb">dir</span> <span class="o">=</span> <span class="s">'short'</span>
            <span class="k">if</span> <span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">event</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">dir</span> <span class="o">=</span> <span class="s">'long'</span>

            <span class="n">pricein</span> <span class="o">=</span> <span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">price</span>
            <span class="n">priceout</span> <span class="o">=</span> <span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">event</span><span class="p">.</span><span class="n">price</span>
            <span class="n">datein</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">dateout</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trade</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">_timeframe</span> <span class="o">&gt;=</span> <span class="n">bt</span><span class="p">.</span><span class="n">TimeFrame</span><span class="p">.</span><span class="n">Days</span><span class="p">:</span>
                <span class="n">datein</span> <span class="o">=</span> <span class="n">datein</span><span class="p">.</span><span class="n">date</span><span class="p">()</span>
                <span class="n">dateout</span> <span class="o">=</span> <span class="n">dateout</span><span class="p">.</span><span class="n">date</span><span class="p">()</span>

            <span class="n">pcntchange</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">priceout</span> <span class="o">/</span> <span class="n">pricein</span> <span class="o">-</span> <span class="mi">100</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">pnlcomm</span>
            <span class="n">pnlpcnt</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">pnl</span> <span class="o">/</span> <span class="n">brokervalue</span>
            <span class="n">barlen</span> <span class="o">=</span> <span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">status</span><span class="p">.</span><span class="n">barlen</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">pnl</span> <span class="o">/</span> <span class="n">barlen</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">cumprofit</span> <span class="o">+=</span> <span class="n">pnl</span>

            <span class="n">size</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">trade</span><span class="p">.</span><span class="n">history</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">size</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">value</span>

            <span class="n">highest_in_trade</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">high</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">ago</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">barlen</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">lowest_in_trade</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">low</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">ago</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">barlen</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">hp</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">highest_in_trade</span> <span class="o">-</span> <span class="n">pricein</span><span class="p">)</span> <span class="o">/</span> <span class="n">pricein</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">lowest_in_trade</span> <span class="o">-</span> <span class="n">pricein</span><span class="p">)</span> <span class="o">/</span> <span class="n">pricein</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s">'long'</span><span class="p">:</span>
                <span class="n">mfe</span> <span class="o">=</span> <span class="n">hp</span>
                <span class="n">mae</span> <span class="o">=</span> <span class="n">lp</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s">'short'</span><span class="p">:</span>
                <span class="n">mfe</span> <span class="o">=</span> <span class="o">-</span><span class="n">lp</span>
                <span class="n">mae</span> <span class="o">=</span> <span class="o">-</span><span class="n">hp</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">trades</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'ref'</span><span class="p">:</span> <span class="n">trade</span><span class="p">.</span><span class="n">ref</span><span class="p">,</span>
             <span class="s">'ticker'</span><span class="p">:</span> <span class="n">trade</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">_name</span><span class="p">,</span>
             <span class="s">'dir'</span><span class="p">:</span> <span class="nb">dir</span><span class="err">，</span>
             <span class="s">'datein'</span><span class="p">:</span> <span class="n">datein</span><span class="p">,</span>
             <span class="s">'pricein'</span><span class="p">:</span> <span class="n">pricein</span><span class="p">,</span>
             <span class="s">'dateout'</span><span class="p">:</span> <span class="n">dateout</span><span class="p">,</span>
             <span class="s">'priceout'</span><span class="p">:</span> <span class="n">priceout</span><span class="p">,</span>
             <span class="s">'chng%'</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pcntchange</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
             <span class="s">'pnl'</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span> <span class="s">'pnl%'</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pnlpcnt</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
             <span class="s">'size'</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
             <span class="s">'value'</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
             <span class="s">'cumpnl'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">cumprofit</span><span class="p">,</span>
             <span class="s">'nbars'</span><span class="p">:</span> <span class="n">barlen</span><span class="p">,</span> <span class="s">'pnl/bar'</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pbar</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
             <span class="s">'mfe%'</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">mfe</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s">'mae%'</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">mae</span><span class="p">,</span> <span class="mi">2</span><span class="p">)})</span>
            
    <span class="k">def</span> <span class="nf">get_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">trades</span>
</code></pre></div></div><p><strong>PyFolio</strong></p><p>BackTrader bt.analyzers.PyFolio，不涉及 PyFolio 库。本节梳理返回的四组数据，都包含哪些内容。</p><table><thead><tr><th style="text-align: center">值</th><th style="text-align: center">变量名</th><th style="text-align: center">说明</th><th style="text-align: center">对应 Analyzer</th></tr></thead><tbody><tr><td style="text-align: center">TimeReturn</td><td style="text-align: center">returns</td><td style="text-align: center">回报序列</td><td style="text-align: center">TimeReturn</td></tr><tr><td style="text-align: center">PositionsValue</td><td style="text-align: center">positions</td><td style="text-align: center">仓位序列</td><td style="text-align: center">PositionsValue</td></tr><tr><td style="text-align: center">Transactions</td><td style="text-align: center">transactions</td><td style="text-align: center">每笔交易，按照 <code class="language-plaintext highlighter-rouge">(size, price, value)</code> 格式记录</td><td style="text-align: center">Transactions</td></tr><tr><td style="text-align: center">GrossLeverage</td><td style="text-align: center">gross_lev</td><td style="text-align: center">追踪总杠杆率（策略的投资额度）。</td><td style="text-align: center">GrossLeverage</td></tr></tbody></table><p>从中可以看出，bt.analyzers.PyFolio 的四组数据，在内部分别由对应的子 Analyzer 负责实现。每组数据的功能，可参见对应的子 Analyzer 介绍文章。</p><h2 id="策略进阶">策略进阶</h2><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653317634&amp;idx=1&amp;sn=e92fec0b0b5fd5f62805e7c2be5830f8&amp;chksm=802da817b75a2101c5812a6fc9daf0b2c08ce21d882bdd3059d2e9f391432b3ac9e950d5e151&amp;cur_album_id=2380299870701420545&amp;scene=189#wechat_redirect">参考</a></p><p>如果策略的收益表现可能受相关参数的影响，需要验证比较参数不同取值对策略表现的影响，就可以使用 Backtrader 的参数优化功能，使用该功能只需通过 cerebro.optstrategy() 方法往大脑添加策略即可：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">Strategy</span><span class="p">):</span>
  
    <span class="n">params</span><span class="o">=</span><span class="p">((</span><span class="s">'period1'</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
            <span class="p">(</span><span class="s">'period2'</span><span class="p">,</span><span class="mi">10</span><span class="p">),)</span> <span class="c1">#全局设定均线周期
</span>    <span class="p">......</span>

    
<span class="c1"># 实例化大脑
</span><span class="n">cerebro1</span><span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">Cerebro</span><span class="p">(</span><span class="n">optdatas</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">optreturn</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># 设置初始资金
</span><span class="n">cerebro1</span><span class="p">.</span><span class="n">broker</span><span class="p">.</span><span class="n">set_cash</span><span class="p">(</span><span class="mi">10000000</span><span class="p">)</span>
<span class="c1"># 加载数据
</span><span class="n">datafeed1</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">PandasData</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="n">data1</span><span class="p">,</span> <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
<span class="n">cerebro1</span><span class="p">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">datafeed1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'600466.SH'</span><span class="p">)</span>

<span class="c1"># 添加优化器
</span><span class="n">cerebro1</span><span class="p">.</span><span class="n">optstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">,</span> <span class="n">period1</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">period2</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># 添加分析指标
# 返回年初至年末的年度收益率
</span><span class="n">cerebro1</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">AnnualReturn</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_AnnualReturn'</span><span class="p">)</span>
<span class="c1"># 计算最大回撤相关指标
</span><span class="n">cerebro1</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">DrawDown</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_DrawDown'</span><span class="p">)</span>
<span class="c1"># 计算年化收益
</span><span class="n">cerebro1</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">Returns</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_Returns'</span><span class="p">,</span> <span class="n">tann</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>
<span class="c1"># 计算年化夏普比率
</span><span class="n">cerebro1</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">SharpeRatio_A</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_SharpeRatio_A'</span><span class="p">)</span>
<span class="c1"># 返回收益率时序
</span><span class="n">cerebro1</span><span class="p">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">TimeReturn</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s">'_TimeReturn'</span><span class="p">)</span>

<span class="c1"># 启动回测
</span><span class="n">result</span> <span class="o">=</span> <span class="n">cerebro1</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># 打印结果
</span><span class="k">def</span> <span class="nf">get_my_analyzer</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># 返回参数
</span>    <span class="n">analyzer</span><span class="p">[</span><span class="s">'period1'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">period1</span>
    <span class="n">analyzer</span><span class="p">[</span><span class="s">'period2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">period2</span>
    <span class="c1"># 提取年化收益
</span>    <span class="n">analyzer</span><span class="p">[</span><span class="s">'年化收益率'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_Returns</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'rnorm'</span><span class="p">]</span>
    <span class="n">analyzer</span><span class="p">[</span><span class="s">'年化收益率（%）'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_Returns</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'rnorm100'</span><span class="p">]</span>
    <span class="c1"># 提取最大回撤(习惯用负的做大回撤，所以加了负号)
</span>    <span class="n">analyzer</span><span class="p">[</span><span class="s">'最大回撤（%）'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_DrawDown</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'max'</span><span class="p">][</span><span class="s">'drawdown'</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 提取夏普比率
</span>    <span class="n">analyzer</span><span class="p">[</span><span class="s">'年化夏普比率'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">analyzers</span><span class="p">.</span><span class="n">_SharpeRatio_A</span><span class="p">.</span><span class="n">get_analysis</span><span class="p">()[</span><span class="s">'sharperatio'</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">analyzer</span>
  
<span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="n">ret</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_my_analyzer</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
<span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

<span class="c1"># 优化结果
</span><span class="n">period1</span> <span class="n">period2</span> <span class="n">年化收益率</span> <span class="n">年化收益率</span><span class="err">（</span><span class="o">%</span><span class="err">）</span> <span class="n">最大回撤</span><span class="err">（</span><span class="o">%</span><span class="err">）</span> <span class="n">年化夏普比率</span>
<span class="mi">0</span>  <span class="mi">5</span>  <span class="mi">10</span>  <span class="mf">4.024514e-05</span>  <span class="mf">4.024514e-03</span>  <span class="o">-</span><span class="mf">0.010175</span>  <span class="o">-</span><span class="mf">140.948647</span>
<span class="mi">1</span>  <span class="mi">5</span>  <span class="mi">20</span>  <span class="o">-</span><span class="mf">3.240455e-06</span>  <span class="o">-</span><span class="mf">3.240455e-04</span>  <span class="o">-</span><span class="mf">0.008839</span>  <span class="o">-</span><span class="mf">229.402157</span>
<span class="mi">2</span>  <span class="mi">5</span>  <span class="mi">30</span>  <span class="o">-</span><span class="mf">1.211110e-05</span>  <span class="o">-</span><span class="mf">1.211110e-03</span>  <span class="o">-</span><span class="mf">0.008674</span>  <span class="o">-</span><span class="mf">236.577612</span>
<span class="mi">3</span>  <span class="mi">5</span>  <span class="mi">40</span>  <span class="o">-</span><span class="mf">1.284502e-05</span>  <span class="o">-</span><span class="mf">1.284502e-03</span>  <span class="o">-</span><span class="mf">0.011886</span>  <span class="o">-</span><span class="mf">370.807650</span>
<span class="mi">4</span>  <span class="mi">10</span>  <span class="mi">10</span>  <span class="mf">0.000000e+00</span>  <span class="mf">0.000000e+00</span>  <span class="o">-</span><span class="mf">0.000000</span>   <span class="n">NaN</span>
<span class="mi">5</span>  <span class="mi">10</span>  <span class="mi">20</span>  <span class="mf">8.568641e-06</span>  <span class="mf">8.568641e-04</span>  <span class="o">-</span><span class="mf">0.009392</span>  <span class="o">-</span><span class="mf">282.835125</span>
<span class="mi">6</span>  <span class="mi">10</span>  <span class="mi">30</span>  <span class="mf">1.835459e-06</span>  <span class="mf">1.835459e-04</span>  <span class="o">-</span><span class="mf">0.008545</span>  <span class="o">-</span><span class="mf">265.568666</span>
<span class="mi">7</span>  <span class="mi">10</span>  <span class="mi">40</span>  <span class="o">-</span><span class="mf">7.817367e-06</span>  <span class="o">-</span><span class="mf">7.817367e-04</span>  <span class="o">-</span><span class="mf">0.013492</span>  <span class="o">-</span><span class="mf">261.387903</span>
<span class="mi">8</span>  <span class="mi">15</span>  <span class="mi">10</span>  <span class="o">-</span><span class="mf">6.560915e-09</span>  <span class="o">-</span><span class="mf">6.560915e-07</span>  <span class="o">-</span><span class="mf">0.017579</span>  <span class="o">-</span><span class="mf">161.893285</span>
<span class="mi">9</span>  <span class="mi">15</span>  <span class="mi">20</span>  <span class="o">-</span><span class="mf">1.857955e-05</span>  <span class="o">-</span><span class="mf">1.857955e-03</span>  <span class="o">-</span><span class="mf">0.009652</span>  <span class="o">-</span><span class="mf">611.196458</span>
<span class="mi">10</span>  <span class="mi">15</span>  <span class="mi">30</span>  <span class="o">-</span><span class="mf">2.226534e-05</span>  <span class="o">-</span><span class="mf">2.226534e-03</span>  <span class="o">-</span><span class="mf">0.008160</span>  <span class="o">-</span><span class="mf">641.959703</span>
<span class="mi">11</span>  <span class="mi">15</span>  <span class="mi">40</span>  <span class="mf">1.708522e-05</span>  <span class="mf">1.708522e-03</span>  <span class="o">-</span><span class="mf">0.013492</span>  <span class="o">-</span><span class="mf">213.637841</span>
<span class="mi">12</span>  <span class="mi">20</span>  <span class="mi">10</span>  <span class="o">-</span><span class="mf">3.799574e-05</span>  <span class="o">-</span><span class="mf">3.799574e-03</span>  <span class="o">-</span><span class="mf">0.025414</span>  <span class="o">-</span><span class="mf">109.665911</span>
<span class="mi">13</span>  <span class="mi">20</span>  <span class="mi">20</span>  <span class="mf">0.000000e+00</span>  <span class="mf">0.000000e+00</span>  <span class="o">-</span><span class="mf">0.000000</span>   <span class="n">NaN</span>
<span class="mi">14</span>  <span class="mi">20</span>  <span class="mi">30</span>  <span class="o">-</span><span class="mf">1.398007e-05</span>  <span class="o">-</span><span class="mf">1.398007e-03</span>  <span class="o">-</span><span class="mf">0.010388</span>  <span class="o">-</span><span class="mf">527.518303</span>
<span class="mi">15</span>  <span class="mi">20</span>  <span class="mi">40</span>  <span class="mf">6.699340e-06</span>  <span class="mf">6.699340e-04</span>  <span class="o">-</span><span class="mf">0.013492</span>  <span class="o">-</span><span class="mf">301.729232</span>
</code></pre></div></div><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653330626&amp;idx=1&amp;sn=83bed9723d81cd6b636f3efff43db926&amp;chksm=802d5ed7b75ad7c19927c4fce4d5da4aa39d87bf9e519f1c5e64ee4aae82cdbb55c7e5ef5c65&amp;cur_album_id=2380299870701420545&amp;scene=189#wechat_redirect">策略案例</a></p></article><div class="share mobile-hidden"><div class="share-component"></div></div><div class="comment mobile-hidden"></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width: 96%" type="text" id="search_box" placeholder="Search" /></div><ul id="search_results" style=" font-size: 14px; list-style-type: none; padding-top: 10px; padding-left: 10px; " ></ul><script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/search_data.json', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 20, fuzzy: false, exclude: ['Welcome'] }); window.onload = function(){ var query_text = window.location.search.substring(1); var vars = query_text.split("&"); for (var i=0;i<vars.length;i++) { var pair = vars[i].split("="); if(pair[0] == "search_text"){ var query = pair[1]; query = decodeURI(query); var search = document.getElementById('search_box'); search.value = query; var event = new InputEvent('keyup'); search.dispatchEvent(event); break } } } </script><h3 class="post-directory-title">Table of Contents</h3><div id="post-directory-module"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/jquery.toc.js"></script><div class="mobile-hidden"><h3>Popular Posts</h3><ul><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2022/12/01/typescript%E7%AC%94%E8%AE%B0/">2022-12 typescript笔记</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2022/08/16/scala%E8%AF%AD%E6%B3%95/">2022-08 scala语法</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/12/26/etcd%E5%92%8Craft/">2021-12 etcd和raft</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/09/08/%E7%8A%B6%E6%80%81%E5%8E%8B%E7%BC%A9/">2021-09 状态压缩</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/01/25/%E5%8D%9A%E5%BC%88%E8%AE%BA/">2021-01 博弈论</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/01/09/%E5%88%86%E5%B8%83%E5%BC%8F%E7%AE%97%E6%B3%95%E5%92%8C%E5%8D%8F%E8%AE%AE/">2021-01 分布式算法和协议</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/12/08/Kafka%E5%8E%9F%E7%90%861-%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/">2020-12 kafka原理1-基础架构</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/12/08/ElasticSearch/">2020-12 ElasticSearch(ES)原理</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/11/29/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E6%80%BB%E7%BB%93/">2020-11 动态规划总结</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/11/12/%E7%BA%BF%E6%AE%B5%E6%A0%91/">2020-11 线段树</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2017/12/03/javascript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">2017-12 javascript笔记</a></h6></ul></div></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="Fulong Ma">Fulong Ma</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="https://www.privacypolicygenerator.info/live.php?token=cnfKULv1VpqenfUs021YVA90fPiK75Cw">Privacy Policy</a></li><li> <a href="https://www.termsfeed.com/live/9dccd944-1b18-436d-bd12-3dd799b1282a">Terms </a></li><li> <a href="javascript:window.scrollTo(0,0)">TOP</a></li></ul><a href="https://github.com/mafulong/mafulong.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://mafulong.github.io/" title="Home" target="">Home</a></li><li> <a href="https://mafulong.github.io/categories/" title="Categories" target="">Categories</a></li><li> <a href="https://mafulong.github.io/archives/" title="Achieves" target="">Achieves</a></li><li> <a href="https://mafulong.github.io/open-source" title="Open-Source" target="">Open-Source</a></li><li> <a href="https://mafulong.github.io/bookmark" title="Bookmark" target="">Bookmark</a></li><li> <a href="https://mafulong.github.io/about" title="About" target="">About</a></li></ul><script async src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script> <script> $(document).ready(function() { $("td img").each(function() { var strA = "<a href='" + this.src + "' itemscope=\"\" itemtype=\"http://schema.org/ImageObject\" itemprop=\"url\" data-fancybox=\"default\" rel=\"default\"></a>"; $(this).wrapAll(strA); }); $("p img").each(function() { var strA = "<a href='" + this.src + "' itemscope=\"\" itemtype=\"http://schema.org/ImageObject\" itemprop=\"url\" data-fancybox=\"default\" rel=\"default\"></a>"; $(this).wrapAll(strA); }); }); </script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function ($) { $('.geopattern').each(function () { $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SS4VDLWLNC"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() {dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SS4VDLWLNC'); </script></div></body></html>
