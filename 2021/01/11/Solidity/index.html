<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="wVZecs0Awis41AZhX45RBAUlyk3nnpoOkebdIemwhxQ" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Solidity &mdash; Fulongのblog</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://mafulong.github.io/2021/01/11/Solidity/"><link rel="alternate" type="application/atom+xml" title="Fulongのblog" href="https://mafulong.github.io"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/favicon.ico"><meta property="og:title" content="Solidity"><meta name="keywords" content="logbook, mafulong"><meta name="og:keywords" content="logbook, mafulong"><meta name="description" content="Solidity"><meta name="og:description" content="Solidity"><meta property="og:url" content="https://mafulong.github.io/2021/01/11/Solidity/"><meta property="og:site_name" content="Fulongのblog"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-01-11"> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://mafulong.github.io/" title="Fulongのblog"><span class="octicon octicon-mark-github"></span> Fulongのblog</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://mafulong.github.io/" class=" site-header-nav-item" target="" title="Home">Home</a> <a href="https://mafulong.github.io/categories/" class=" site-header-nav-item" target="" title="Categories">Categories</a> <a href="https://mafulong.github.io/archives/" class=" site-header-nav-item" target="" title="Achieves">Achieves</a> <a href="https://mafulong.github.io/open-source" class=" site-header-nav-item" target="" title="Open-Source">Open-Source</a> <a href="https://mafulong.github.io/bookmark" class=" site-header-nav-item" target="" title="Bookmark">Bookmark</a> <a href="https://mafulong.github.io/about" class=" site-header-nav-item" target="" title="About">About</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Solidity"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Solidity</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/01/11 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://mafulong.github.io/categories/#Web3" title="Web3">Web3</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 5439 字，约 16 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h2 id="solidity">Solidity</h2><p><a href="https://guide.pseudoyu.com/zh/docs/solidity/learn_solidity_from_scratch_basic/">参考</a></p><h2 id="智能合约-与-solidity-语言">智能合约 与 Solidity 语言</h2><p>智能合约是运行在链上的程序，合约开发者可以通过智能合约实现与链上资产/数据进行交互，用户可以通过自己的链上账户来调用合约，访问资产与数据。因为区块链保留区块历史记录的链式结构、去中心化、不可篡改等特征，智能合约相比传统应用来说能更公正、透明。</p><p>然而，因为智能合约需要与链进行交互，部署、数据写入等操作都会消耗一定费用，数据存储与变更成本也比较高，因此在设计合约时需要着重考虑资源的消耗。此外，常规智能合约一经部署就无法进行修改，因此，合约设计时也需要多考虑其安全性、可升级性与拓展性。</p><p>Solidity 是一门面向合约的、为实现智能合约而创建的高级编程语言，在 EVM 虚拟机上运行，语法整体类似于 Javascript，是目前最流行的智能合约语言，也是入门区块链与 Web3 所必须掌握的语言。</p><h3 id="编写合约">编写合约</h3><p>编写一个以太坊合约相当于编写一个类，一个合约可以包含多个成员变量和若干函数，以及可选的构造函数；</p><p>部署一个合约相当于实例化，部署时刻将执行构造函数；</p><p>任何外部账户均可发起对合约函数的调用，但一个交易仅限一个函数调用；</p><p>所有检查都必须在合约的函数内部完成。</p><p><a href="https://liaoxuefeng.com/books/blockchain/ethereum/smart-contract/write-contract/index.html">参考</a></p><p>以太坊的智能合约就是一段由EVM虚拟机执行的字节码，类似于Java虚拟机执行Java字节码。直接编写字节码非常困难，通常都是由编译器负责把高级语言编译为字节码。</p><p>编写以太坊合约最常用的高级语言是Solidity，这是一种类似JavaScript语法的高级语言。通过Solidity的<a href="https://soliditylang.org/">官方网站</a>可以快速上手，我们不会详细讨论Solidity的语法细节，这里给出一个简单的投票合约：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: GPL-3.0</span>

<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">=</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">7</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>

    <span class="nx">event</span> <span class="nx">Voted</span><span class="p">(</span><span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">voter</span><span class="p">,</span> <span class="nx">uint8</span> <span class="nx">proposal</span><span class="p">);</span>

    <span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">voted</span><span class="p">;</span>

    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">endTime</span><span class="p">;</span>

    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">proposalA</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">proposalB</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">proposalC</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">_endTime</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">endTime</span> <span class="o">=</span> <span class="nx">_endTime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">uint8</span> <span class="nx">_proposal</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">&lt;</span> <span class="nx">endTime</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Vote expired.</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">_proposal</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">_proposal</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Invalid proposal.</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="o">!</span><span class="nx">voted</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">],</span> <span class="dl">"</span><span class="s2">Cannot vote again.</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">voted</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_proposal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">proposalA</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_proposal</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">proposalB</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_proposal</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">proposalC</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">emit</span> <span class="nx">Voted</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">_proposal</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">votes</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">proposalA</span> <span class="o">+</span> <span class="nx">proposalB</span> <span class="o">+</span> <span class="nx">proposalC</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Solidity注释和JavaScript一致，第一行通常是版权声明的注释，然后声明编译器版本：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">=</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">7</span><span class="p">;</span> <span class="c1">// 指定编译器版本为0.8.7</span>
</code></pre></div></div><p>也可以指定版本范围，如：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">&gt;=</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.9</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span> <span class="c1">// 指定编译器版本为0.8.x</span>
</code></pre></div></div><p>紧接着，由关键字<code class="language-plaintext highlighter-rouge">contract</code>声明一个合约：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>
    <span class="p">...</span> <span class="c1">// 合约代码</span>
<span class="p">}</span>
</code></pre></div></div><p>虽然一个Solidity文件可以包含多个合约，但最好还是遵循一个文件一个合约，且文件名保持与合约一致。这里的合约名是<code class="language-plaintext highlighter-rouge">Vote</code>。</p><p>熟悉面向对象编程的小伙伴对类、成员变量、成员方法一定不陌生。一个合约就相当于一个类，合约内部可以有成员变量：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>
    <span class="c1">// 记录已投票的地址:</span>
    <span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">bool</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">voted</span><span class="p">;</span>

    <span class="c1">// 记录投票终止时间:</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">endTime</span><span class="p">;</span>

    <span class="c1">// 记录得票数量:</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">proposalA</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">proposalB</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">proposalC</span><span class="p">;</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div><p>Solidity支持整型（细分为<code class="language-plaintext highlighter-rouge">uint256</code>、<code class="language-plaintext highlighter-rouge">uint128</code>、<code class="language-plaintext highlighter-rouge">uint8</code>等）、<code class="language-plaintext highlighter-rouge">bytes32</code>类型、映射类型（相当于Java的Map）、布尔型（<code class="language-plaintext highlighter-rouge">true</code>或<code class="language-plaintext highlighter-rouge">false</code>）和特殊的<code class="language-plaintext highlighter-rouge">address</code>类型表示一个以太坊地址。</p><p>以太坊合约<em>不支持</em>浮点数类型，是为了保证每个节点运行合约都能得到完全相同的结果。浮点数运算在不同的ISA体系下存在表示方式、运算精度的不同，无法保证两个节点执行浮点运算会得到相同的结果。</p><p>所有的成员变量都默认初始化为<code class="language-plaintext highlighter-rouge">0</code>或<code class="language-plaintext highlighter-rouge">false</code>（针对bool）或空（针对mapping）。</p><p>如果某个成员变量要指定初始值，那么需要在构造函数中赋值：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="c1">// 构造函数:</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">_endTime</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">endTime</span> <span class="o">=</span> <span class="nx">_endTime</span><span class="p">;</span> <span class="c1">// 设定成员变量endTime为指定参数值</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div><p>以太坊合约支持读、写两种类型的成员函数，以<code class="language-plaintext highlighter-rouge">view</code>修饰的函数是只读函数，它不会修改成员变量，即不会改变合约的状态：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="kd">function</span> <span class="nx">votes</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">proposalA</span> <span class="o">+</span> <span class="nx">proposalB</span> <span class="o">+</span> <span class="nx">proposalC</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div><p>没有<code class="language-plaintext highlighter-rouge">view</code>修饰的函数是写入函数，它会修改成员变量，即改变了合约的状态：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">uint8</span> <span class="nx">_proposal</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">&lt;</span> <span class="nx">endTime</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Vote expired.</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">_proposal</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">_proposal</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Invalid proposal.</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="o">!</span><span class="nx">voted</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">],</span> <span class="dl">"</span><span class="s2">Cannot vote again.</span><span class="dl">"</span><span class="p">);</span>
        <span class="c1">// 给mapping增加一个key-value:</span>
        <span class="nx">voted</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_proposal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 修改proposalA:</span>
            <span class="nx">proposalA</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_proposal</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 修改proposalB:</span>
            <span class="nx">proposalB</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_proposal</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 修改proposalC:</span>
            <span class="nx">proposalC</span> <span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">emit</span> <span class="nx">Voted</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">_proposal</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div><p>合约可以定义事件（Event），我们在Vote合约中定义了一个<code class="language-plaintext highlighter-rouge">Voted</code>事件：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>
    <span class="c1">// Voted事件，有两个相关值:</span>
    <span class="nx">event</span> <span class="nx">Voted</span><span class="p">(</span><span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">voter</span><span class="p">,</span> <span class="nx">uint8</span> <span class="nx">proposal</span><span class="p">);</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div><p>只定义事件还不够，触发事件必须在合约的写函数中通过<code class="language-plaintext highlighter-rouge">emit</code>关键字实现。当调用<code class="language-plaintext highlighter-rouge">vote()</code>写方法时，会触发<code class="language-plaintext highlighter-rouge">Voted</code>事件：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">contract</span> <span class="nx">Vote</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">uint8</span> <span class="nx">_proposal</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="nx">emit</span> <span class="nx">Voted</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">_proposal</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div><p>事件可用来通知外部感兴趣的第三方，他们可以在区块链上监听产生的事件，从而确认合约某些状态发生了改变。</p><p>以上就是用Solidity编写一个完整的合约所涉及的几个要素：</p><ul><li>声明版权（可选）；</li><li>声明编译器版本；</li><li>以contract关键字编写一个合约；</li><li>可以包含若干成员变量；</li><li>可以在构造函数中对成员变量初始化（可选）；</li><li>可以编写只读方法；</li><li>可以编写写入方法；</li><li>可以声明Event并在写入方法中触发。</li></ul><p>函数又可以用<code class="language-plaintext highlighter-rouge">public</code>或<code class="language-plaintext highlighter-rouge">private</code>修饰。顾名思义，<code class="language-plaintext highlighter-rouge">public</code>函数可以被外部调用，而<code class="language-plaintext highlighter-rouge">private</code>函数不能被外部调用，他们只能被<code class="language-plaintext highlighter-rouge">public</code>函数在内部调用。</p><h3 id="合约执行流程">合约执行流程</h3><p>当一个合约编写完成并成功编译后，我们就可以把它部署到以太坊上。合约部署后将自动获得一个地址，通过该地址即可访问合约。</p><p>把<code class="language-plaintext highlighter-rouge">contract Vote {...}</code>看作一个类，部署就相当于一个实例化。如果部署两次，将得到两个不同的地址，相当于实例化两次，两个部署后的合约对应的成员变量是完全独立的，互不影响。</p><p>构造函数在部署合约时就会立刻执行，且仅执行一次。合约部署后就无法调用构造函数。</p><p>任何外部账户都可以发起对合约的函数调用。如果调用只读方法，因为不改变合约状态，所以任何时刻都可以调用，且不需要签名，也不需要消耗Gas。但如果调用写入方法，就需要签名提交一个交易，并消耗一定的Gas。</p><p>在一个交易中，只能调用一个合约的一个写入方法。无需考虑并发和同步的问题，因为以太坊交易的写入是严格串行的。</p><h3 id="验证">验证</h3><p>由于任何外部账户都可以发起对合约的函数调用，所以任何验证工作都必须在函数内部自行完成。最常用的<code class="language-plaintext highlighter-rouge">require()</code>可以断言一个条件，如果断言失败，将抛出错误并中断执行。</p><p>常用的检查包括几类：</p><p>参数检查：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 参数必须为1,2,3:</span>
<span class="nx">require</span><span class="p">(</span><span class="nx">_proposal</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">_proposal</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Invalid proposal.</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div><p>条件检查：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 当前区块时间必须小于设定的结束时间:</span>
<span class="nx">require</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">&lt;</span> <span class="nx">endTime</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Vote expired.</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div><p>调用方检查：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// msg.sender表示调用方地址:</span>
<span class="nx">require</span><span class="p">(</span><span class="o">!</span><span class="nx">voted</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">],</span> <span class="dl">"</span><span class="s2">Cannot vote again.</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div><p>以太坊合约具备类似数据库事务的特点，如果中途执行失败，则整个合约的状态保持不变，不存在修改某个成员变量后，后续断言失败导致部分修改生效的问题：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">increment</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 假设a,b均为成员变量:</span>
    <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">emit</span> <span class="nx">AChanged</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="c1">// 如果下面的验证失败，a不会被更新，也没有AChanged事件发生:</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">b</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="dl">'</span><span class="s1">b &gt;= 10</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">b</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>即合约如果执行失败，其状态不会发生任何变化，也不会有任何事件发生，仅仅是调用方白白消耗了一定的Gas。</p><h2 id="开发调试工具">开发/调试工具</h2><p>与常规编程语言不同，Solidity 智能合约的开发往往无法直接通过一个 IDE 或本地环境进行方便的调试，而是需要与一个链上节点进行交互。开发调试往往也不会直接与主网（即真实资产、数据与业务所在的链）进行交互，否则需要承担高额手续费。目前开发调试主要有以下几种方式与框架：</p><ol><li><a href="https://remix.ethereum.org/">Remix IDE</a>。通过 Ethereum 官方提供的基于浏览器的 Remix 开发工具进行调试，Remix 会提供完整的 IDE、编译工具、部署调试的测试节点环境、账户等，可以很方便地进行测试，这是我学习使用时用的最多的工具。Remix 还可以通过 MetaMask 插件与测试网、主网进行直接交互，部分生产环境也会使用它进行编译部署。</li><li><a href="https://github.com/trufflesuite/truffle">Truffle</a>。Truffle 是一个非常流行的 Javascript 的 Solidity 合约开发框架，提供了完整的开发、测试、调试工具链，可以与本地或远程网络进行交互。</li><li><a href="https://github.com/eth-brownie/brownie">Brownie</a>。Brownie 是一个基于 Python 的 Solidity 合约开发框架，以简洁的 Python 语法为调试和测试提供了便捷的工具链。</li><li><a href="https://github.com/NomicFoundation/hardhat">Hardhat</a>。Hardhat 是另一个基于 Javascript 的开发框架，提供了非常丰富的插件系统，适合开发复杂的合约项目。</li></ol><p><strong>Fundry 是什么？ 也是个开发框架？从 B 站上看到的，待定。</strong></p><p>除了开发框架外，更好地进行 Solidity 还需要熟悉一些工具：</p><ol><li>Remix IDE 对于语法提示等并不完善，因此，可以使用 <a href="https://code.visualstudio.com/">Visual Studio Code</a> 配合 <a href="https://marketplace.visualstudio.com/items?itemName=juanblanco.solidity">Solidity</a> 进行编写，有更好的体验。</li><li><a href="https://metamask.io/">MetaMask</a>。一个常用的钱包应用，开发过程中可以通过浏览器插件与测试网、主网进行交互，方便开发者进行调试。</li><li><a href="https://trufflesuite.com/ganache/">Ganache</a>。Ganache 是一个开源的虚拟本地节点，提供了一个虚拟链网络，可以通过各类 Web3.js、Remix 或一些框架工具与之交互，适合有一定规模的项目进行本地调试与测试。</li><li><a href="https://infura.io/">Infura</a>。Infura 是一个 IaaS（Infrastructure as a Service）产品，我们可以申请自己的 Ethereum 节点，通过 Infura 提供的 API 进行交互，可以很方便地进行调试，也更接近生产环境。</li><li><a href="https://www.openzeppelin.com/">OpenZeppelin</a>。OpenZeppelin 提供了非常多的合约开发库与应用，能兼顾安全、稳定的同时给予开发者更好的开发体验，降低合约开发成本。</li></ol><h2 id="合约编译部署">合约编译/部署</h2><p>Solidity 合约是以 <code class="language-plaintext highlighter-rouge">.sol</code> 为后缀的文件，无法直接执行，需要编译为 EVM（Ethereum Virtual Machine）可识别的字节码才能在链上运行。</p><p><img src="https://cdn.jsdelivr.net/gh/mafulong/mdPic@vv6/v6/202506281017561.png" alt="compile_solidity" /></p><p>编译完成后，由合约账户进行部署到链上，其他账户可通过钱包与合约进行交互，实现链上业务逻辑。</p></article><div class="share mobile-hidden"><div class="share-component"></div></div><div class="comment mobile-hidden"></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width: 96%" type="text" id="search_box" placeholder="Search" /></div><ul id="search_results" style=" font-size: 14px; list-style-type: none; padding-top: 10px; padding-left: 10px; " ></ul><script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/search_data.json', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 20, fuzzy: false, exclude: ['Welcome'] }); window.onload = function(){ var query_text = window.location.search.substring(1); var vars = query_text.split("&"); for (var i=0;i<vars.length;i++) { var pair = vars[i].split("="); if(pair[0] == "search_text"){ var query = pair[1]; query = decodeURI(query); var search = document.getElementById('search_box'); search.value = query; var event = new InputEvent('keyup'); search.dispatchEvent(event); break } } } </script><h3 class="post-directory-title">Table of Contents</h3><div id="post-directory-module"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/jquery.toc.js"></script><div class="mobile-hidden"><h3>Popular Posts</h3><ul><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2022/12/01/typescript%E7%AC%94%E8%AE%B0/">2022-12 typescript笔记</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2022/08/16/scala%E8%AF%AD%E6%B3%95/">2022-08 scala语法</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/12/26/etcd%E5%92%8Craft/">2021-12 etcd和raft</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/09/08/%E7%8A%B6%E6%80%81%E5%8E%8B%E7%BC%A9/">2021-09 状态压缩</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/01/25/%E5%8D%9A%E5%BC%88%E8%AE%BA/">2021-01 博弈论</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2021/01/09/%E5%88%86%E5%B8%83%E5%BC%8F%E7%AE%97%E6%B3%95%E5%92%8C%E5%8D%8F%E8%AE%AE/">2021-01 分布式算法和协议</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/12/08/Kafka%E5%8E%9F%E7%90%861-%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/">2020-12 kafka原理1-基础架构</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/12/08/ElasticSearch/">2020-12 ElasticSearch(ES)原理</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/11/29/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E6%80%BB%E7%BB%93/">2020-11 动态规划总结</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2020/11/12/%E7%BA%BF%E6%AE%B5%E6%A0%91/">2020-11 线段树</a></h6><h6 class="repo-list-name font16px"> <a href="https://mafulong.github.io/2017/12/03/javascript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">2017-12 javascript笔记</a></h6></ul></div></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="Fulong Ma">Fulong Ma</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="https://www.privacypolicygenerator.info/live.php?token=cnfKULv1VpqenfUs021YVA90fPiK75Cw">Privacy Policy</a></li><li> <a href="https://www.termsfeed.com/live/9dccd944-1b18-436d-bd12-3dd799b1282a">Terms </a></li><li> <a href="javascript:window.scrollTo(0,0)">TOP</a></li></ul><a href="https://github.com/mafulong/mafulong.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://mafulong.github.io/" title="Home" target="">Home</a></li><li> <a href="https://mafulong.github.io/categories/" title="Categories" target="">Categories</a></li><li> <a href="https://mafulong.github.io/archives/" title="Achieves" target="">Achieves</a></li><li> <a href="https://mafulong.github.io/open-source" title="Open-Source" target="">Open-Source</a></li><li> <a href="https://mafulong.github.io/bookmark" title="Bookmark" target="">Bookmark</a></li><li> <a href="https://mafulong.github.io/about" title="About" target="">About</a></li></ul><script async src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script> <script> $(document).ready(function() { $("td img").each(function() { var strA = "<a href='" + this.src + "' itemscope=\"\" itemtype=\"http://schema.org/ImageObject\" itemprop=\"url\" data-fancybox=\"default\" rel=\"default\"></a>"; $(this).wrapAll(strA); }); $("p img").each(function() { var strA = "<a href='" + this.src + "' itemscope=\"\" itemtype=\"http://schema.org/ImageObject\" itemprop=\"url\" data-fancybox=\"default\" rel=\"default\"></a>"; $(this).wrapAll(strA); }); }); </script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/mafulong/mafulong.github.io@built/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function ($) { $('.geopattern').each(function () { $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SS4VDLWLNC"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() {dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SS4VDLWLNC'); </script></div></body></html>
