---
layout: post
category: Web3
title: 区块链入门QA
tags: Web3

---

## 区块链入门QA

# 基础

## 合约

### 1. 普通转账与合约交易

- **ETH 转账**：
  - 直接链上余额变动，不需要合约。
  - `to` 就是收款人的钱包地址。
- **代币转账（ERC-20/721/1155 等）**：
  - 本质是调用合约的函数（如 `transfer` / `transferFrom`）。
  - `to` 指向代币合约地址，收款人地址要在交易 data 或日志里找。
- **合约部署**：
  - `to=null`，执行成功后生成一个新合约地址。

------

### 2. transfer 函数

- **标准由谁定义**：以太坊社区通过 ERC 提案流程规定接口（如 `transfer`、`balanceOf`）。
- **具体谁写的**：各代币项目方自己实现（比如 USDT 的 Tether 团队）。
- **作用**：修改合约内部的 `balances` 映射，并触发 `Transfer` 事件。

------

### 3. transfer 会变吗？

- **不可升级合约**：一旦部署，代码永久写死，`transfer` 不会变。
- **可升级合约（Proxy 模式）**：接口不变，但项目方可升级逻辑。比如 Tether 正在迁移到 USDT0，用了 proxy 机制。

------

### 4. 合约地址会变吗？

- **不会变**：由 `部署者地址 + nonce` 算出，一旦部署就永久固定。
- **新版本合约**：如果项目迁移（比如旧 USDT → 新 USDT0），那是**新合约新地址**，旧地址依然存在，不会“变掉”。

---

## 区块链账本模型对比

| 模型         | 代表链                      | 优点                         | 缺点                     |
| ------------ | --------------------------- | ---------------------------- | ------------------------ |
| **UTXO**     | Bitcoin、Litecoin           | 去中心化、并行度高、隐私好   | 编程复杂，不适合复杂合约 |
| **账户模型** | Ethereum、TRON、BNB、Solana | 直观，支持智能合约，开发友好 | 隐私差，容易被追踪       |

✅ 一句话总结：  

- **UTXO 模型**：像现金，交易是“零钱的输入输出”。  
- **账户模型**：像银行卡，账本直接记录“谁有多少钱”。  

---

## 常见区块链架构

| Chain         | 类型   | 共识机制                    | 主币种 | 架构/特点                 | 交易速度    | 交易费用               | 主要应用         | 特点                                           |
| ------------- | ------ | --------------------------- | ------ | ------------------------- | ----------- | ---------------------- | ---------------- | ---------------------------------------------- |
| **Bitcoin**   | 公有链 | PoW (工作量证明)            | BTC    | UTXO 模型，简单安全       | 7 TPS       | 较高（波动大）         | 价值存储、支付   | **去中心化**，**比特币为主**，手续费和速度较低 |
| **Ethereum**  | 公有链 | PoS (权益证明)              | ETH    | EVM，智能合约，去中心化   | 10-20 TPS   | 高（依赖网络拥堵）     | DeFi、NFT        | **去中心化**，**智能合约平台**，费用受网络影响 |
| **TRON**      | 公有链 | DPoS (委托权益证明)         | TRX    | EVM 兼容，高性能          | 2,000+ TPS  | 低（固定费用）         | 支付、USDT       | **高吞吐量**，**低手续费**，**账户冻结**机制   |
| **BNB Chain** | 公有链 | PoSA (权益质押+权威)        | BNB    | 高吞吐量，EVM 兼容        | 3,000+ TPS  | 低（固定费用）         | DeFi、GameFi     | **高吞吐量**，**EVM 兼容**，适合DeFi应用       |
| **Solana**    | 公有链 | PoH+PoS (历史证明+权益证明) | SOL    | 高性能，Rust 开发         | 50,000+ TPS | 极低（固定费用）       | 高频交易、GameFi | **超高TPS**，**低延迟**，非常适合高频交易      |
| **Avalanche** | 公有链 | Avalanche+PoS               | AVAX   | 子网架构，EVM 兼容        | 4,500 TPS   | 低（固定费用）         | DeFi、应用链     | **子网架构**，**高可扩展性**，适合定制化链     |
| **Polkadot**  | 公有链 | NPoS (提名权益证明)         | DOT    | 中继链+平行链，多链互操作 | 1,000 TPS   | 中等（取决于链和交易） | 跨链生态         | **跨链通信**，**共享安全**，适合多链生态       |
| **Cosmos**    | 公有链 | Tendermint+PoS              | ATOM   | Hub-Zone，IBC 跨链通信    | 1,000+ TPS  | 中等（按链和交易）     | 模块化链、跨链   | **模块化链设计**，**跨链互操作**，多链生态     |
| **Base**      | L2     | Rollup (OP)                 | ETH    | 以太坊 L2，Coinbase 背书  | 2,000+ TPS  | 低（较以太坊）         | DeFi、Web3入口   | **以太坊 L2**，**低手续费**，高效的交易环境    |



## 共识

### PBFT 总结

#### 核心思想

- 在 **3f + 1** 个节点中，最多允许 **f 个拜占庭节点**（作恶/故障）。  
- 通过 **多阶段消息交互**，保证所有诚实节点最终达成一致。  

**目标**：在存在拜占庭节点时，仍能保证 **一致性**（所有诚实节点对交易顺序达成一致）。

---

#### 工作流程（四步）

1. **Request**：客户端请求发给主节点（Leader）。  
2. **Pre-prepare**：主节点分配序号并广播。  
3. **Prepare**：所有副本节点验证并互相广播。  
   - 收到 ≥2f+1 一致消息 → 进入提交阶段。  
4. **Commit**：节点广播提交消息，收集到 ≥2f+1 → 执行并回复客户端。  

---

### Nakamoto 共识

- PoW / PoS / PoX。  
- 特点：引入经济学手段，牺牲确定性，换来大规模可扩展性。  



------

### 共识机制对比

- **Nakamoto 共识（PoW/PoS/PoX）**：经济学手段，牺牲确定性，换取可扩展性。
- **PBFT**：小规模、高确定性，适合联盟链。

---

## 多签

1. TON 链，用户被骗，被多签了。  
2. 设备迁移过，发送交易的地址和签名地址不一样。  





# Web3 签名转账 & Gas 机制笔记

## 1. 签名转账上链流程

1. **准备交易参数**（nonce, to, value, data, gasLimit, fee 设置, chainId）。
2. **本地序列化并签名**（私钥签名 → ECDSA → rawTx）。
3. **广播交易到网络**（进入节点的 mempool）。
4. **区块提议者/验证者打包并共识**。
5. **状态更新**：ETH 余额变动 / ERC20 合约执行日志。

## 2. 交易参数详解（ETH / ERC20）

- **nonce**：交易序号，保证顺序和防重放。
- **to**：
  - ETH 转账：收款人地址。
  - ERC20 转账：代币合约地址。
- **value**：
  - ETH 转账：金额（wei）。
  - ERC20 转账：=0。
- **data**：
  - ETH 转账：空。
  - ERC20 转账：`transfer(to, amount)` 的 ABI 编码。
- **gasLimit**：最大 Gas 消耗（ETH 转账约 21,000，ERC20 转账约 50,000–80,000）。
- **maxPriorityFeePerGas**：小费，激励打包者优先选择你的交易。
- **maxFeePerGas**：最高 Gas 单价上限，防止被宰。
- **chainId**：链的 ID，防止跨链重放。



笔记：

- **Gas = 运算量**，**Fee = 运算量 × 单价**。
- **BaseFee** 销毁，**PriorityFee** 给打包者，**MaxFee** 保护用户。
- ETH 在高使用期可能通缩，冷清期可能轻微通胀。

------

## 3. BaseFee / PriorityFee / MaxFee

- **BaseFee**
  - 每个区块自动调整的最低费率。
  - 所有交易必须至少支付。
  - 直接销毁（burn），不会给打包者。
- **PriorityFee（tip）**
  - 用户额外支付的小费。
  - 直接归打包者。
  - 设置越高，打包越快。
- **MaxFee**
  - 用户愿意支付的最高 Gas 单价。
  - 实际支付不会超过这个值。

公式：

```
实际单价 = min(MaxFee , BaseFee + PriorityFee)
手续费 = gasUsed × 实际单价
```

------

## 4. 手续费计算示例

条件：

- `gasUsed = 21,000`
- `BaseFee = 20 gwei`
- `MaxFee = 40 gwei`
- `PriorityFee = 2 gwei`

计算：

- 实际单价 = min(40, 20+2) = 22 gwei
- 手续费 = 21,000 × 22 gwei ≈ 0.000462 ETH

分配：

- 21,000 × 20 gwei = 0.00042 ETH → **销毁**
- 21,000 × 2 gwei = 0.000042 ETH → **打包者收入**

------

## 5. Gas 单位与 Fee 单位

- **Gas**：EVM 运算步骤数，虚拟单位，不是货币。
- **Gas Price / Fee Per Gas**：每单位 Gas 的价格，单位 wei/gas（常用 gwei）。
- **Fee**：最终手续费，= gasUsed × 实际单价，结果单位 ETH。



------

## 6. ETH 销毁机制

- **BaseFee 部分被销毁**，使 ETH 带有通缩属性。
- 链上活动高峰期：销毁量 > 增发量 → **ETH 净通缩**。
- 活动低迷期：销毁量 < 增发量 → **ETH 轻微通胀**。
- ETH 总量 = 增发（质押奖励） - 销毁（BaseFee）。

# Web3 账户与标准笔记

## 1. EOA（Externally Owned Account, 外部账户）
- **定义**：由私钥控制的账户，没有代码逻辑。
- **特点**：
  - 可以主动发起交易（通过签名）。
  - 有余额（ETH、代币）。
  - 没有合约逻辑，不能自己执行函数。
- **应用场景**：用户钱包地址（MetaMask、硬件钱包等）。
- **安全风险**：私钥泄露 = 资金完全丢失。

---

## 2. 合约账户（Contract Account, CA）
- **定义**：由合约代码控制的账户，没有私钥。
- **特点**：
  - 不能主动发起交易，只能被调用。
  - 有合约逻辑，能执行复杂功能。
  - 创建时需要部署合约，支付 gas。
- **应用场景**：
  - ERC-20 / ERC-721 / ERC-1155 代币合约。
  - DEX（如 Uniswap）、借贷协议（如 Aave）。
  - 多签钱包、DAO 金库。
- **安全风险**：合约漏洞可能导致资金被盗。

---

## 3. EOA 与 合约账户对比

| 特性         | EOA (外部账户) | 合约账户 (CA)             |
| ------------ | -------------- | ------------------------- |
| 控制方式     | 私钥           | 合约代码                  |
| 是否能发交易 | ✅ 主动         | ❌ 只能被动响应            |
| 是否有代码   | ❌ 无           | ✅ 有逻辑                  |
| 创建方式     | 生成公私钥即可 | 部署合约时自动生成        |
| 应用场景     | 用户钱包       | 代币、DEX、借贷、NFT、DAO |

合约账户是每次部署合约生成的。



## 4. EIP-7702

- **背景**：
  - 传统 EOA 功能有限（只能签名/发交易）。
  - 合约账户功能强大，但迁移成本高。
- **定义**：
  - 让 EOA 在一笔交易中，临时「挂接合约逻辑」。
  - 表现得像一个合约账户，交易执行后恢复 EOA。
- **作用**：
  - 一次签名即可执行多步操作（如 approve → swap → stake）。
  - 批量交易、自动支付、社交恢复、多签。
  - 支持代付 gas，不一定要用 ETH。
- **关系**：
  - 7702 不是新建合约账户，而是给 EOA 临时附加“合约能力”。

---

## 5. 为什么需要 7702？
1. **扩展 EOA 功能**：支持批量操作、代付 gas。
2. **兼容性好**：不必换钱包地址，旧的 EOA 也能获得新功能。
3. **安全**：可以在交易中添加风控逻辑（多签、限制转账等）。
4. **Account Abstraction**：迈向账户抽象的关键一步。

---

## 6. 7702 与补贴gas 的关系
- **问题**：传统 EOA 只能用 ETH 支付 gas，不能指定其他代币。
- **解决**：
  - 通过 7702，让 EOA 在该交易中变身为“合约账户”。
  - 合约账户逻辑可以：
    - 指定由第三方 Paymaster 代付 gas。
    - 使用 USDT/DAI 等代币抵扣 gas。
    - 让 DApp 赞助 gas 费用。
- 结论： 补贴gas代付机制需要依赖 7702 的“合约逻辑”，否则普通 EOA 无法实现。

---

## 7. 一次签名，多步操作
- **传统方式**：每步操作（approve、swap、stake）都要单独签名、支付 gas。
- **7702/AA 方式**：
  - 把多个操作打包成一次交易。
  - 用户一次签名，合约账户在链上依次执行。
- **好处**：
  - 提升用户体验（少签名）。
  - 节省 gas（共享部分开销）。
  - 原子性：要么全部成功，要么全部失败。

---

## 总结
- **EOA**：由私钥控制的钱包，简单但功能有限。
- **合约账户**：由代码控制，功能强大但不能主动发交易。
- **EIP-7702**：让 EOA 临时获得合约账户能力，实现批量交易、代付 gas、账户抽象。
- **补贴Gas**：依赖 7702 才能实现灵活的 Gas 支付（代币代付、第三方代付）。