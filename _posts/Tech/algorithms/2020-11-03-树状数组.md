---
layout: post
category: Algorithms
title: æ ‘çŠ¶æ•°ç»„
tags: Algorithms
---

## æ ‘çŠ¶æ•°ç»„

[ç†è§£å…¥é—¨](https://zhuanlan.zhihu.com/p/25185969)

[è¿›é˜¶, å¿…çœ‹ï¼](https://www.cnblogs.com/dilthey/p/9366491.html)

æ ‘çŠ¶æ•°ç»„ï¼ˆBinary Indexed Treeï¼‰, è¯¥ç®—æ³•å¤šç”¨äºé«˜æ•ˆè®¡ç®—æ•°åˆ—çš„å‰ç¼€å’Œï¼Œ åŒºé—´å’ŒåŠ¨æ€å•ç‚¹å€¼çš„ä¿®æ”¹



è¿™é‡Œå¼•å…¥ä¸€ç§æ•°æ®ç»“æ„ - æ ‘çŠ¶æ•°ç»„ ( Binary Indexed Treeï¼ŒBITï¼ŒäºŒåˆ†ç´¢å¼•æ ‘ )ï¼Œå®ƒåªæœ‰ä¸¤ç§åŸºæœ¬æ“ä½œï¼Œå¹¶ä¸”éƒ½æ˜¯æ“ä½œçº¿æ€§è¡¨çš„æ•°æ®çš„ï¼š

      1ã€add( i, 1 )      (1<=i<=n)                       å¯¹ç¬¬iä¸ªå…ƒç´ çš„å€¼è‡ªå¢1           O(logn)
      2ã€sum( i )         (1<=i<=n)                       ç»Ÿè®¡[1...i]å…ƒç´ å€¼çš„å’Œ             O(logn)


è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœç”¨HASHæ¥å®ç°è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆ1çš„å¤æ‚åº¦æ˜¯O(1)ï¼Œè€Œ2çš„å¤æ‚åº¦å°±æ˜¯O(n)äº†ï¼Œè€Œæ ‘çŠ¶æ•°ç»„å®ç°çš„è¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥è®©ä¸¤è€…çš„å¤æ‚åº¦éƒ½è¾¾åˆ°O(logn)

æœ‰äº†è¿™ä¸¤ç§æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä»¬è½¬åŒ–æˆä¹‹å‰è®¾è®¡çš„æ•°æ®ç»“æ„çš„é‚£ä¸‰ç§æ“ä½œï¼Œé¦–å…ˆï¼š

1. æ’å…¥(Insert)ï¼Œå¯¹åº”çš„æ˜¯ add(i, 1)ï¼Œæ—¶é—´å¤æ‚åº¦O( logn )
2. åˆ é™¤(Delete), å¯¹åº”çš„æ˜¯ add(i, -1), æ—¶é—´å¤æ‚åº¦O( logn )
3. è¯¢é—®(Query), æ±‚åŒºé—´å’Œæˆ–è€…a[i]çš„å€¼

è®°ä½iè¦å¤§äº1ï¼Œ å› ä¸ºlowbit(0) = 0ä¼šæ­»å¾ªç¯



![æ ‘çŠ¶æ•°ç»„è¯¦ç»†è®²è§£ï¼Œä¸ä¼šç®—æ³•ä¹Ÿèƒ½çœ‹æ‡‚å“¦~](https://cdn.jsdelivr.net/gh/mafulong/mdPic@master/images/569759172fd2522ac82c89da8de0a332.jpeg)

### åŸºæœ¬æ“ä½œ

#### lowbit

```
def lowbit(self, x):
    return x & (-x)
```

å› æ­¤i+lowbit(i)å…¶å®ä»£è¡¨æ˜¯å®ƒçˆ¶çº§å¯¹åº”çš„indexï¼Œæ¯”å¦‚c4ç”±c3å’Œc2ç´¯åŠ è€Œæˆï¼Œc2å’Œc3çš„+lowbit(i)å°±æ˜¯c4çš„ä½ç½®ã€‚

i-lowbit(i)å…¶å®æ˜¯æ²¡æœ‰çˆ¶å­ç¥–å…ˆå…³ç³»å¹³çº§çš„æœ€å¤§èŠ‚ç‚¹ï¼Œæ¯”å¦‚c4ã€c6ã€c7ã€a8æ˜¯å¹³çº§çš„ã€‚index=8çš„lowbit(8) = 8ï¼Œå°±å›åˆ°äº†0. 

index=7çš„lowbit(7) = 1, å›åˆ°äº†c6.

#### æ›´æ–°add

æ›´æ–°a[i]å’ŒåŒ…å«a[i]çš„ä¸€ç³»åˆ—c[i]çš„å€¼

```
//xä»£è¡¨ä½ç½®ï¼Œdataå¸¦è¡¨è¦åŠ ä¸Šçš„å€¼
void add (int x,int data)
{
    for (int i=x;i<=n;i+=lowbit(i))
            tree[i]+=data;
}
```

#### ç»Ÿè®¡sum

æ±‚1åˆ°indexä¸ºxçš„å’Œ

```
//æ±‚1åˆ°xçš„å’Œ
int sum (int x)
{
    int ans=0;
    for (int i=x;i>=1;i-=lowbit(i))
            ans+=tree[i];
    return ans;
}
```

#### æ ‘çŠ¶æ•°ç»„åˆ›å»º

å¯¹æ¯ä¸ªa[i] ä¾æ¬¡addå³å¯ï¼Œ n*o(n)

å®é™…ä¸Šå¯ä»¥o(n)

æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼æ˜¯ç”±æ‰€æœ‰ä¸è‡ªå·±ç›´æ¥ç›¸è¿çš„å„¿å­çš„å€¼æ±‚å’Œå¾—åˆ°çš„ã€‚å› æ­¤å¯ä»¥å€’ç€è€ƒè™‘è´¡çŒ®ï¼Œå³æ¯æ¬¡ç¡®å®šå®Œå„¿å­çš„å€¼åï¼Œç”¨è‡ªå·±çš„å€¼æ›´æ–°è‡ªå·±çš„ç›´æ¥çˆ¶äº²ã€‚

```c
// O(n)å»ºæ ‘
void init() {
  for (int i = 1; i <= n; ++i) {
    t[i] += a[i];
    int j = i + lowbit(i);
    if (j <= n) t[j] += t[i];
  }
}
```



### åœºæ™¯

æœ‰ä»¥ä¸‹åœºæ™¯åˆ†ç±»ï¼š

    â‘  å•ç‚¹ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ æ ‘çŠ¶æ•°ç»„
    
    â‘¡ åŒºé—´æŸ¥è¯¢ã€å•ç‚¹ä¿®æ”¹ æ ‘çŠ¶æ•°ç»„
    
    â‘¢ åŒºé—´æŸ¥è¯¢ã€åŒºé—´ä¿®æ”¹ æ ‘çŠ¶æ•°ç»„
    
    â‘£ äºŒç»´æ ‘çŠ¶æ•°ç»„
    
    ã€€ã€€å•ç‚¹ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ äºŒç»´æ ‘çŠ¶æ•°ç»„
    
    ã€€ã€€åŒºé—´ä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢ äºŒç»´æ ‘çŠ¶æ•°ç»„
    
    ã€€ã€€åŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ äºŒç»´æ ‘çŠ¶æ•°ç»„

#### å•ç‚¹ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢

åŸå§‹é—®é¢˜

#### åŒºé—´ä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢

a[i]å­˜çš„æ˜¯a[i]-a[i-1]

å…¶å®è¿™ä¸ªçš„åŸç†å°±æ˜¯ï¼šé€šè¿‡å·®åˆ†æŠŠè¿™ä¸ªåŒºé—´ä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢çš„é—®é¢˜è½¬åŒ–ä¸ºâ‘ ï¼›

é¦–å…ˆï¼Œå‡è®¾æˆ‘ä»¬è¦è®°å½•çš„æ•°ç»„æ˜¯ğ‘[1:ğ‘›]a[1:n]ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‡è®¾æœ‰ğ‘‘[ğ‘–]=ğ‘[ğ‘–]âˆ’ğ‘[ğ‘–âˆ’1]d[i]=a[i]âˆ’a[iâˆ’1]ï¼Œä¸”ğ‘‘[1]=ğ‘[1]d[1]=a[1]ï¼Œ

æ˜¾ç„¶ï¼Œå°±æœ‰ğ‘[ğ‘–]=ğ‘‘[1]+ğ‘‘[2]+â‹¯+ğ‘‘[ğ‘–]a[i]=d[1]+d[2]+â‹¯+d[i]ï¼Œ

æˆ‘ä»¬åœ¨BITä¸­å®é™…å­˜å‚¨çš„æ˜¯æ•°ç»„ğ‘‘[1:ğ‘›]d[1:n]ï¼ˆå‡†ç¡®çš„è¯´æ˜¯dæ•°ç»„çš„æ ‘çŠ¶æ•°ç»„ï¼‰ï¼›

å…ˆè¯´**ä¿®æ”¹**ï¼š

ã€€ã€€æˆ‘ä»¬ç›®æ ‡æ˜¯ç»™ğ‘[ğ¿:ğ‘…]a[L:R]å…¨éƒ¨åŠ ä¸Šğ‘¥xï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œå…¶å®ğ‘‘[ğ¿+1],ğ‘‘[ğ¿+2],â‹¯,ğ‘‘[ğ‘…]d[L+1],d[L+2],â‹¯,d[R]éƒ½æ²¡æœ‰å˜åŒ–ï¼Œ

ã€€ã€€è€Œå˜åŒ–çš„åªæœ‰ï¼šğ‘‘[ğ¿]d[L]å¢åŠ äº†ğ‘¥xï¼Œğ‘‘[ğ‘…+1]d[R+1]å‡å°‘äº†ğ‘¥xï¼›

ã€€ã€€æ‰€ä»¥åªéœ€è¦add(L,x),add(R+1,-x)å³å¯ã€‚

å†è¯´**æŸ¥è¯¢**ï¼š

ã€€ã€€æˆ‘ä»¬è¦å•ç‚¹æŸ¥è¯¢ğ‘[ğ‘ğ‘œğ‘ ]a[pos]ï¼Œç”±ä¸Šå¯çŸ¥ğ‘[ğ‘ğ‘œğ‘ ]=ğ‘‘[1]+ğ‘‘[2]+â‹¯+ğ‘‘[ğ‘ğ‘œğ‘ ]a[pos]=d[1]+d[2]+â‹¯+d[pos]ï¼Œ

ã€€ã€€é‚£ä¹ˆåŸæ¥çš„sum(pos)å‡½æ•°ä¸ç”¨ä¿®æ”¹ï¼Œå°±æ­£å¥½èƒ½è¿”å›ğ‘[ğ‘ğ‘œğ‘ ]a[pos]çš„å€¼ã€‚



```c
//BIT - åŒºé—´ä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢ - st
struct _BIT{
    int N,C[MAXN];
    int lowbit(int x){return x&(-x);}
    void init(int n) //åˆå§‹åŒ–å…±æœ‰nä¸ªç‚¹
    {
        N=n;
        for(int i=1;i<=N;i++) C[i]=0;
    }
    void add(int pos,int val)
    {
        while(pos<=N) C[pos]+=val,pos+=lowbit(pos);
    }
    void range_add(int l,int r,int x) //åŒºé—´[l,r]åŠ x
    {
        add(l,x);
        add(r+1,-x);
    }
    int ask(int pos) //æŸ¥è¯¢posç‚¹çš„å€¼
    {
        int ret=0;
        while(pos>0)
        {
            ret+=C[pos];
            pos-=lowbit(pos);
        }
        return ret;
    }
}BIT;
//BIT - åŒºé—´ä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢ - ed
```

####  åŒºé—´æŸ¥è¯¢ã€åŒºé—´ä¿®æ”¹

æˆ‘ä»¬çœ‹åˆ°ï¼Œå¯¹äºåŒºé—´ä¿®æ”¹ç”±äºæˆ‘ä»¬ç›®æ ‡è®°å½•çš„æ˜¯æ•°ç»„a[1:n]ï¼Œè€Œå®é™…å­˜å‚¨çš„æ˜¯d[1:n]ï¼Œdå°±æ˜¯å·®åˆ†

é‚£ä¹ˆå·²ç»å®ç°äº†åŒºé—´ä¿®æ”¹ï¼Œå¦‚ä½•å®ŒæˆåŒºé—´æŸ¥è¯¢å‘¢ï¼Ÿæ˜¾ç„¶ï¼ŒåŒºé—´æŸ¥è¯¢çš„åŸºç¡€æ˜¯å¿«é€Ÿæ±‚æ•°ç»„a[1:n]çš„å‰ç¼€å’Œï¼Œ

æ˜¾ç„¶æ•°ç»„a[1:n]çš„å‰ç¼€å’Œï¼š

ã€€ã€€ğ‘[1]+ğ‘[2]+â‹¯+ğ‘[ğ‘–]=ğ‘‘[1]Ã—ğ‘–+ğ‘‘[2]Ã—(ğ‘–âˆ’1)+â‹¯+ğ‘‘[ğ‘–]Ã—1a[1]+a[2]+â‹¯+a[i]=d[1]Ã—i+d[2]Ã—(iâˆ’1)+â‹¯+d[i]Ã—1

ä¸éš¾å‘ç°å³ä¾§å¯ä»¥åŒ–æˆï¼š

ã€€ã€€ğ‘‘[1]Ã—ğ‘–+ğ‘‘[2]Ã—(ğ‘–âˆ’1)+â‹¯+ğ‘‘[ğ‘–]Ã—1=[ğ‘‘[1]Ã—(ğ‘–+1)+ğ‘‘[2]Ã—(ğ‘–+1)+â‹¯+ğ‘‘[ğ‘–]Ã—(ğ‘–+1)]âˆ’[ğ‘‘[1]Ã—1+ğ‘‘[2]Ã—2+â‹¯+ğ‘‘[ğ‘–]Ã—ğ‘–]=(ğ‘–+1)Ã—(ğ‘‘[1]+ğ‘‘[2]+â‹¯+ğ‘‘[ğ‘–])âˆ’(ğ‘‘[1]Ã—1+ğ‘‘[2]Ã—2+â‹¯+ğ‘‘[ğ‘–]Ã—ğ‘–)d[1]Ã—i+d[2]Ã—(iâˆ’1)+â‹¯+d[i]Ã—1=[d[1]Ã—(i+1)+d[2]Ã—(i+1)+â‹¯+d[i]Ã—(i+1)]âˆ’[d[1]Ã—1+d[2]Ã—2+â‹¯+d[i]Ã—i]=(i+1)Ã—(d[1]+d[2]+â‹¯+d[i])âˆ’(d[1]Ã—1+d[2]Ã—2+â‹¯+d[i]Ã—i)

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æƒ³åˆ°ï¼Œåœ¨åŸæ¥çš„æ•°ç»„ğ¶[ğ‘–]è®°å½•ğ‘‘[ğ‘–]çš„åŸºç¡€ä¸Šï¼Œ

å†æä¸€ä¸ªæ•°ç»„ğ¶2[ğ‘–]è®°å½•ğ‘‘[ğ‘–]Ã—ğ‘–å³å¯ã€‚ï¼ˆå½“ç„¶ï¼Œå®é™…å†™ä»£ç çš„æ—¶å€™è¦æ˜ç¡®ï¼ŒCæ•°ç»„å’ŒC2æ•°ç»„éƒ½æ˜¯æ ‘çŠ¶æ•°ç»„ï¼Œä¸æ˜¯åŸæ•°ç»„ï¼‰



ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨c1=d[1:n], c2=d[1:n]*i

å•ç‚¹addæ—¶: c1[i]+=val, c2[i]+=val*i

åŒºé—´range_addæ—¶, l,r,val: add(l,val), add(r+1,-val)

å•ç‚¹sumæ—¶: ```for(int i=pos;i>0;i-=lowbit(i)) ret+=(pos+1)*C[i]-C2[i];```

åŒºé—´sum,range_askæ—¶:sum(r)-sum(l-1)

```c
//BIT - åŒºé—´ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢ - st
struct _BIT{
    int N;
    ll C[MAXN],C2[MAXN]; //åˆ†åˆ«è®°å½•d[i]å’Œd[i]*i
    int lowbit(int x){return x&(-x);}
    void init(int n) //åˆå§‹åŒ–å…±æœ‰nä¸ªç‚¹
    {
        N=n;
        memset(C,0,sizeof(C));
        memset(C2,0,sizeof(C2));
    }
    void add(int pos,ll val)
    {
        for(int i=pos;i<=N;i+=lowbit(i)) C[i]+=val,C2[i]+=val*pos;
    }
    void range_add(int l,int r,ll x) //åŒºé—´[l,r]åŠ ä¸Šx
    {
        add(l,x);
        add(r+1,-x);
    }
    ll ask(int pos)
    {
        ll ret=0;
        for(int i=pos;i>0;i-=lowbit(i)) ret+=(pos+1)*C[i]-C2[i];
        return ret;
    }
    ll range_ask(int l,int r) //æŸ¥è¯¢åŒºé—´[l,r]çš„å’Œ
    {
        return ask(r)-ask(l-1);
    }
}BIT;
//BIT - åŒºé—´ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢ - ed
```



### åº”ç”¨

### æ•Œå…µå¸ƒé˜µé—®é¢˜ï¼š
[é¢˜ç›®é“¾æ¥](http://acm.hdu.edu.cn/showproblem.php?pid=1166)


æœ‰Nä¸ªå†›äº‹åŸºåœ°ï¼ŒåŸºåœ°ç¼–å·ä»0 åˆ°N-1ï¼Œæ¯ä¸ªåŸºåœ°æœ‰ä¸åŒæ•°é‡çš„å£«å…µï¼Œå£«å…µæ•°é‡å¯èƒ½å‘ç”Ÿå¢å‡ï¼Œå¦‚ä½•å°½å¿«çš„æ±‚å‡ºä»ç¬¬kä¸ªåŸºåœ°åˆ°ç¬¬mä¸ªåŸºåœ°çš„å£«å…µæ€»æ•°ï¼Ÿ

### æ±‚é€†åºå¯¹æ•°é‡

ç»™ä¸€ä¸ª1~nçš„æ’åˆ—ï¼Œæ±‚æ»¡è¶³i<jä¸”a[i]>a[j]çš„äºŒå…ƒç»„å¯¹æ•°ï¼Œæ¯”å¦‚[4,2,1,5,3]è¿™ä¸ªåºåˆ—ï¼Œæ»¡è¶³æ¡ä»¶çš„äºŒå…ƒç»„ä¸º{<4,2>, <4,1>, <4,3>, <2,1>, <5,3>}ï¼Œæ•…é€†åºæ•°æ˜¯5



æ ‘çŠ¶æ•°ç»„æ±‚é€†åºæ•°çš„åŸç†

é¦–å…ˆæ˜ç¡®æ ‘çŠ¶æ•°ç»„åœ¨æ­¤é—®é¢˜ä¸­ç»´æŠ¤ä¿¡æ¯æ˜¯æŸä¸ªåŒºé—´ä¸­æ•°å­—å‡ºç°çš„ä¸ªæ•°ï¼Œå°†æºæ•°æ®æŒ‰å…¶åŸæœ¬é¡ºåºæ’å…¥æ ‘çŠ¶æ•°ç»„ï¼Œç¬¬iä¸ªæ•°å­—æ’å…¥çš„æ–¹å¼ä¸ºå°†æ ‘çŠ¶æ•°ç»„çš„ç¬¬a[i]ä½è®¾ä¸º1ï¼ŒåŒæ—¶æ›´æ–°è¦†ç›–åˆ°å®ƒçš„çˆ¶åŒºé—´ï¼ŒQuery(a[i])å¯æ±‚å¾—[1, a[i]]çš„åŒºé—´å’Œï¼Œè¿™æ°å¥½ä»£è¡¨ç¬¬iä¸ªæ•°å­—å‰å°äºç­‰äºå®ƒçš„ä¸ªæ•°ï¼Œç­‰äºçš„åªå¯èƒ½æ˜¯è‡ªèº«ï¼Œæ•…å°äºå®ƒçš„æœ‰Query(a[i])-1ä¸ªï¼Œé‚£ä¹ˆå¤§äºå®ƒçš„æ˜¾ç„¶å°±æœ‰i-1-(Query(a[i])-1) = i-Query(a[i])ä¸ª

```cpp

for (int i = 1; i <= n; i++) {
    Update(a[i], 1);
    ans += i - Query(a[i]);
}

```


### æ›´å¤šé¢˜ç›®
[æ›´å¤šé¢˜ç›®](https://blog.csdn.net/weixin_45677913/article/details/102481587?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.pc_relevant_is_cache&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.pc_relevant_is_cache)

## åªå¤„ç†ç®€å•çš„ï¼Œå¤æ‚çš„äº¤ç»™çº¿æ®µæ ‘ã€‚

åªå¤„ç†ç®€å•çš„ï¼Œå•ç‚¹æ›´æ–°ï¼ŒåŒºé—´æŸ¥è¯¢çš„add,sumæ ‘ã€‚å¤æ‚çš„éƒ½äº¤ç»™çº¿æ®µæ ‘ã€‚

### python3æ¨¡æ¿

å³åªèƒ½å•ç‚¹addï¼Œç„¶ååŒºé—´æ±‚å’Œã€‚

æ¨¡æ¿

```python
# æ ‘çŠ¶æ•°ç»„æ¨¡æ¿
class BIT:
    def __init__(self, n):
        self.tree = [0] * n

    # å°†ä¸‹æ ‡ i ä¸Šçš„æ•°åŠ ä¸€
    def inc(self, i: int) -> None:
        while i < len(self.tree):
            self.tree[i] += 1
            i += i & -i

    # è¿”å›é—­åŒºé—´ [1, i] çš„å…ƒç´ å’Œ
    def sum(self, i: int) -> int:
        res = 0
        while i > 0:
            res += self.tree[i]
            i &= i - 1
        return res

    # è¿”å›é—­åŒºé—´ [left, right] çš„å…ƒç´ å’Œ
    def query(self, left: int, right: int) -> int:
        return self.sum(right) - self.sum(left - 1)

```



ä½¿ç”¨

```python
class TestBIT(TestCase):
    def test_query(self):
        t = lt.BIT(100)
        t.inc(1)
        t.inc(3)
        t.inc(7)
        t.inc(50)
        assert t.sum(3) == 2
        assert t.sum(7) == 3
        assert t.query(3, 7) == 2
        assert t.query(3, 51) == 3
        t.inc(3)
        assert t.sum(3) == 3
        assert t.sum(7) == 4
        assert t.query(3, 7) == 3
        assert t.query(3, 51) == 4

```



