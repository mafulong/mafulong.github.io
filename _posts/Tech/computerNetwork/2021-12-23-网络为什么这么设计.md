---
layout: post
category: ComputerNetwork
title: 网络为什么这么设计
tags: ComputerNetwork
---



## tcp为什么粘包？

粘包就是数据A和数据B顺序发送，结果A和B一起发送了。

这是tcp特性：基于字节流，然后有个算法会优化，如果数据太小并且一定时间内还有数据就一起发送，节省发送次数。

这其实不是问题，需要开发者自己识别消息边界。

## udp分片？

udp不分片，要分片也是ip协议进行的分片。

一个包会分为多个片发送，如果一个片丢了那么就需要重新发送整个包，非常浪费，因此也是建议有最大大小： 65507字节。

tcp是tcp和ip都有分片。

## 为什么IP和TCP需要分片和分段？

- IP 协议拆分数据是因为物理设备的限制，一次能够传输的数据由路径上 MTU 最小的设备决定，一旦 IP 协议传输的数据包超过 MTU 的限制就会发生分片，所以我们需要通过路径 MTU 发现获取传输路径上的 MTU 限制；
- TCP 协议拆分数据是为了保证传输的可靠性和顺序，作为可靠的传输协议，为了保证数据的传输顺序，它需要为每一个数据段增加包含序列号的 TCP 协议头，如果数据段大小超过了 IP 协议的 MTU 限制， 就会带来更多额外的重传和重组开销，影响性能。

## 既然IP层会分片，为什么TCP层也还要分段？

**数据在TCP分段，就是为了在IP层不需要分片，同时发生重传的时候只重传分段后的小份数据**。籍此来保证效率，不需要整个重传。



另外ip层包大小限制来自于数据链路层，因此如果遇到了特殊的要求，限制很小，还是会ip分片的。



TCP分段时使用MSS，IP分片时使用MTU

MSS是通过MTU计算得到，在三次握手和发送消息时都有可能产生变化。

IP分片是**不得已**的行为，尽量不在IP层分片，尤其是链路上中间设备的IP分片。因此，在IPv6中已经禁止中间节点设备对IP报文进行分片，分片只能在链路的最开头和最末尾两端进行。

## tcp为什么三次握手？

TCP 建立连接时通过三次握手可以有效地避免历史错误连接的建立，减少通信双方不必要的资源消耗，三次握手能够帮助通信双方获取初始化序列号，它们能够保证数据包传输的不重不丢，还能保证它们的传输顺序，不会因为网络传输的问题发生混乱，到这里不使用『两次握手』和『四次握手』的原因已经非常清楚了：

- 『两次握手』：无法避免历史错误连接的初始化，浪费接收方的资源；
- 『四次握手』：TCP 协议的设计可以让我们同时传递 `ACK` 和 `SYN` 两个控制信息，减少了通信次数，所以不需要使用更多的通信次数传输相同的信息；

## 为什么tcp有性能问题？

TCP 协议的一些设计在今天来看虽然仍然具有巨大的价值，但是并不能适用于所有场景。为了解决 TCP 的性能问题，目前业界有两种解决方案：

1. 使用 UDP 构建性能更加优异、更灵活的传输协议，例如：QUIC[19](https://draveness.me/whys-the-design-tcp-performance/#fn:19) 等；
2. 通过不同的手段优化 TCP 协议的性能，例如：选择性 ACK（Selective ACK, SACK），TCP 快开启（TCP Fast Open, TFO）；

由于 TCP 协议在操作系统内核中，不利于协议的更新，所以第一种方案目前发展的更好，HTTP/3 就使用了 QUIC 作为传输协议[20](https://draveness.me/whys-the-design-tcp-performance/#fn:20)。我们在这里重新回顾一下导致 TCP 性能问题的三个重要原因：

- TCP 的拥塞控制在发生丢包时会进行退让，减少能够发送的数据段数量，但是丢包并不一定意味着网络拥塞，更多的可能是网络状况较差；
- TCP 的三次握手带来了额外开销，这些开销不只包括需要传输更多的数据，还增加了首次传输数据的网络延迟；
- TCP 的重传机制在数据包丢失时可能会重新传输已经成功接收的数据段，造成带宽的浪费；

## 为什么DNS不用TCP?

无论是选择 UDP 还是 TCP，最核心的矛盾就在于需要传输的数据包大小，如果数据包小到一定程度，UDP 协议绝对最佳的选择。



当数据包大到一定程度，tcp握手等额外开销变得无足轻重时，自然是选择更可靠的tcp。

## 参考

- [为什么这么设计系列文章](https://draveness.me/whys-the-design/)

- [动图图解！既然IP层会分片，为什么TCP层也还要分段？](https://juejin.cn/post/6961578444774146078)