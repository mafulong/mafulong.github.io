---
layout: post
category: Java
title: java类加载机制
tags: Java
---

## java类加载机制

## 类加载机制核心知识点总结

| 阶段                         | 说明                                             |
| ---------------------------- | ------------------------------------------------ |
| **加载（Loading）**          | 读取 `.class` 文件，生成 `Class` 对象            |
| **验证（Verification）**     | 字节码格式验证、安全性验证                       |
| **准备（Preparation）**      | 分配静态变量内存并初始化默认值                   |
| **解析（Resolution）**       | 将符号引用转换为直接引用                         |
| **初始化（Initialization）** | 执行 `<clinit>` 方法，初始化静态变量和静态代码块 |



### ✅ 类加载器分类

| 加载器                      | 作用                              |
| --------------------------- | --------------------------------- |
| **Bootstrap ClassLoader**   | 加载 JDK 核心类，如 `java.lang.*` |
| **Extension ClassLoader**   | 加载 `ext` 目录下的扩展类         |
| **Application ClassLoader** | 加载 CLASSPATH 中的类             |
| **自定义 ClassLoader**      | 通过继承 `ClassLoader` 自定义逻辑 |



### ✅ 双亲委派模型（Parent Delegation）

> 加载请求会先委托给父加载器，层层向上，只有父类加载器无法加载时，才由当前加载器尝试加载。



**双亲委派模型有什么好处？**

- 避免重复加载
- 防止核心类被篡改（如你写了一个 `java.lang.String`）



## SPI

SPI（**Service Provider Interface**，服务提供接口）是 Java 提供的一种 **服务发现机制**，用于实现模块间的解耦，常用于框架底层或插件式架构中。



1. **定义接口（服务接口）**
2. **实现接口（服务提供者）**
3. **在资源目录 `/META-INF/services/` 下新建一个以接口全限定名命名的文件**
4. **文件内容是具体的实现类的全限定名**



| 场景                      | 例子                                |
| ------------------------- | ----------------------------------- |
| JDBC 驱动注册             | `DriverManager` 通过 SPI 加载驱动类 |
| 日志框架适配              | SLF4J -> Logback、Log4j             |
| Java 加密实现（JCE）      | 加载不同加密算法                    |
| Dubbo、Spring Boot 插件化 | 实现模块间解耦、插件注入            |



**SPI 有什么缺点？**

- 加载是全量的，**不能懒加载**
- 实现类无法按条件优先级排序
- 配置文件容易拼写出错，不易调试
- 类加载器隔离问题（如 OSGi、Tomcat）可能导致无法发现服务



改进方案

| 技术              | 优势                                                        |
| ----------------- | ----------------------------------------------------------- |
| Spring SPI        | 提供条件过滤、排序、懒加载等功能（如 `spring.factories`）。 |
| Dubbo SPI         | 增强 SPI，支持注解、扩展点自动激活                          |
| Java 9 Module SPI | 基于 `module-info.java` 实现模块化 SPI                      |



Spring SPI = Spring 提供的一套 **基于配置文件**的接口发现与扩展机制。

**核心思想**：在 `META-INF/spring.factories` 文件中，配置接口与实现类映射，Spring 会在运行时自动加载。





## QA

### **类是何时被加载进 JVM 的？**

- 第一次主动使用时，比如：
  - 创建对象（`new`）
  - 访问静态变量、方法
  - 反射调用 `Class.forName()`
  - 子类初始化会先触发父类初始化

### **类加载器之间的关系是继承还是组合？**

> 是组合关系，`ClassLoader` 实例之间通过 `parent` 字段关联，不是继承树。



### 类加载调试与工具

- 查看类加载器：`getClass().getClassLoader()`
- 显示加载路径：`System.getProperty("java.class.path")`
- `jcmd`, `jmap`, `jstack`：排查类加载问题
- 使用 `-verbose:class` 观察类加载过程



### **什么时候会破坏双亲委派模型？**

- 自定义 ClassLoader 加载特定类（如 SPI 机制）
- Tomcat、Spring Boot 为了实现热部署，故意打破模型