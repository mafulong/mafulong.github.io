---
layout: post
category: Java
title: Javaå¹¶å‘åŒ…å’Œçº¿ç¨‹æ± 
tags: Java
---

## Javaå¹¶å‘åŒ…å’Œçº¿ç¨‹æ± 

## JDK å¹¶å‘åŒ…

### é‡å…¥é”

å‡ ä¸ªé‡è¦æ–¹æ³•
re-entrance-lock

```java
lock.lock();
//è·å¾—é”ï¼Œå¦‚å ç”¨ï¼Œåˆ™ç­‰å¾…
lockInteruptibly()ï¼›
//è·å¾—é”ï¼Œä½†ä¼˜å…ˆå“åº”ä¸­æ–­ï¼Œå°±æ˜¯å¯ä»¥ä¸­æ–­çš„
tryLock()ï¼›
//å¤±è´¥è¿”å›false,ä¸ç­‰å¾…
tryLock(time,unit);
//åœ¨ç»™å®šæ—¶é—´å†…å°è¯•è·å¾—é”
unlock();
//é‡Šæ”¾é”
```

### é‡å…¥é”çš„å¥½æ­æ¡£ï¼šCondition æ¡ä»¶

condition.await()å’Œ wait()ç±»ä¼¼

condition.signal()å’Œ notify()ç±»ä¼¼

è¦åœ¨ lock å—å†…

### Semaphore

ä¿¡å·é‡æœºåˆ¶

å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®

```java
Semaphore semaphore=new semaphore(int permits);//permitsæ˜¯ä¸ªè®¸å¯è¯


run(){
    semaphore.acquire();

    ..

    semaphore.release();
}
```

ä»¥ä¸‹ä»£ç æ¨¡æ‹Ÿäº†å¯¹æŸä¸ªæœåŠ¡çš„å¹¶å‘è¯·æ±‚ï¼Œæ¯æ¬¡åªèƒ½æœ‰ 3 ä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—®ï¼Œè¯·æ±‚æ€»æ•°ä¸º 10ã€‚

```java
public class SemaphoreExample {
    public static void main(String[] args) {
        final int clientCount = 3;
        final int totalRequestCount = 10;
        Semaphore semaphore = new Semaphore(clientCount);
        ExecutorService executorService = Executors.newCachedThreadPool();
        for (int i = 0; i < totalRequestCount; i++) {
            executorService.execute(()->{
                try {
                    semaphore.acquire();
                    System.out.print(semaphore.availablePermits() + " ");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    semaphore.release();
                }
            });
        }
        executorService.shutdown();
    }
}
```

resutl:
2 1 2 2 2 2 2 1 2 2

### ReadWriteLock

è¯»å†™åˆ†ç¦»é”ï¼Œå¯ä»¥å‡å°‘é”ç«äº‰ï¼Œæå‡æ€§èƒ½

### CountdownLatch

å°±æ˜¯å€’è®¡æ•°çš„é”å­˜æœŸï¼Œå¯ä»¥è®©çº¿ç¨‹ç­‰å¾…ç›´åˆ°å€’è®¡æ—¶ç»“æŸï¼Œå†å¼€å§‹æ‰§è¡Œ

ç”¨æ¥æ§åˆ¶ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¤šä¸ªçº¿ç¨‹ã€‚

ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ cntï¼Œæ¯æ¬¡è°ƒç”¨ countDown() æ–¹æ³•ä¼šè®©è®¡æ•°å™¨çš„å€¼å‡ 1ï¼Œå‡åˆ° 0 çš„æ—¶å€™ï¼Œé‚£äº›å› ä¸ºè°ƒç”¨ await() æ–¹æ³•è€Œåœ¨ç­‰å¾…çš„çº¿ç¨‹å°±ä¼šè¢«å”¤é†’ã€‚

```java
public class CountdownLatchExample {

    public static void main(String[] args) throws InterruptedException {
        final int totalThread = 10;
        CountDownLatch countDownLatch = new CountDownLatch(totalThread);
        ExecutorService executorService = Executors.newCachedThreadPool();
        for (int i = 0; i < totalThread; i++) {
            executorService.execute(() -> {
                System.out.print("run..");
                countDownLatch.countDown();
            });
        }
        countDownLatch.await();
        System.out.println("end");
        executorService.shutdown();
    }
}
```

result:

    run..run..run..run..run..run..run..run..run..run..end

### CyclicBarrier

å…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°éƒ½åˆ°è¾¾æŸä¸ªå…¬å…±å±éšœç‚¹

ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œåªæœ‰å½“å¤šä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾æ—¶ï¼Œè¿™äº›çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚

å’Œ CountdownLatch ç›¸ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ç»´æŠ¤è®¡æ•°å™¨æ¥å®ç°çš„ã€‚ä½†æ˜¯å®ƒçš„è®¡æ•°å™¨æ˜¯é€’å¢çš„ï¼Œæ¯æ¬¡æ‰§è¡Œ await() æ–¹æ³•ä¹‹åï¼Œè®¡æ•°å™¨ä¼šåŠ  1ï¼Œç›´åˆ°è®¡æ•°å™¨çš„å€¼å’Œè®¾ç½®çš„å€¼ç›¸ç­‰ï¼Œç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚å’Œ CountdownLatch çš„å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼ŒCyclicBarrier çš„è®¡æ•°å™¨å¯ä»¥å¾ªç¯ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒæ‰å«åšå¾ªç¯å±éšœã€‚

è¿™ä¸ªæ˜¯è§„å®šå¤šå°‘ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸€å®šæ•°é‡çš„çº¿ç¨‹éƒ½åˆ°è¾¾ await()æ—¶æ‰å¼€å§‹éƒ½å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œ

```java
public class CyclicBarrierExample {
    public static void main(String[] args) throws InterruptedException {
        final int totalThread = 10;
        CyclicBarrier cyclicBarrier = new CyclicBarrier(totalThread);
        ExecutorService executorService = Executors.newCachedThreadPool();
        for (int i = 0; i < totalThread; i++) {
            executorService.execute(() -> {
                System.out.print("before..");
                try {
                    cyclicBarrier.await();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } catch (BrokenBarrierException e) {
                    e.printStackTrace();
                }
                System.out.print("after..");
            });
        }
        executorService.shutdown();
    }
}
```

result:

```
before..before..before..before..before..before..before..before..before..before..after..after..after..after..after..after..after..after..after..after..
```

### Exchanger

ç”¨äºä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´æ•°æ®çš„åŒæ­¥äº¤æ¢ï¼Œéƒ½å‡†å¤‡å¥½æ‰äº¤æ¢

## çº¿ç¨‹æ± 

[çº¿ç¨‹æ± çš„ç²—æµ…ä½¿ç”¨](https://www.jianshu.com/p/edd7cb4eafa0)

[çº¿ç¨‹æ± çš„åˆ†æ](http://ifeve.com/java-threadpool/)

[çº¿ç¨‹æ± åˆ†ææ›´å¥½äº›](https://www.cnblogs.com/absfree/p/5357118.html)

åˆç†åˆ©ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥ä¸‰ä¸ªå¥½å¤„ã€‚ç¬¬ä¸€ï¼šé™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚ç¬¬äºŒï¼šæé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚ç¬¬ä¸‰ï¼šæé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚ä½†æ˜¯è¦åšåˆ°åˆç†çš„åˆ©ç”¨çº¿ç¨‹æ± ï¼Œå¿…é¡»å¯¹å…¶åŸç†äº†å¦‚æŒ‡æŒã€‚

### åˆ›å»ºçº¿ç¨‹æ± 

ä¸€èˆ¬é€šè¿‡å·¥å…·ç±» Executors çš„é™æ€æ–¹æ³•æ¥è·å–çº¿ç¨‹æ± æˆ–é™æ€æ–¹æ³•ã€‚ä»‹ç»å››ç§å¸¸ç”¨åˆ›å»ºæ–¹æ³•

å•ä¾‹çº¿ç¨‹ï¼Œè¡¨ç¤ºåœ¨ä»»æ„çš„æ—¶é—´æ®µå†…ï¼Œçº¿ç¨‹æ± ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œ

```java
ExecutorService service1 = Executors.newSingleThreadExecutor();
```

ç¼“å­˜çº¿ç¨‹æ± ï¼Œå…ˆæŸ¥çœ‹çº¿ç¨‹æ± ä¸­æ˜¯å¦æœ‰å½“å‰æ‰§è¡Œçº¿ç¨‹çš„ç¼“å­˜ï¼Œå¦‚æœæœ‰å°± resue(å¤ç”¨),å¦‚æœæ²¡æœ‰,é‚£ä¹ˆéœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆå½“å‰çš„è°ƒç”¨.å¹¶ä¸”è¿™ç±»çº¿ç¨‹æ± åªèƒ½å®Œæˆä¸€äº›ç”Ÿå­˜æœŸå¾ˆçŸ­çš„ä¸€äº›ä»»åŠ¡.å¹¶ä¸”è¿™ç±»çº¿ç¨‹æ± å†…éƒ¨è§„å®šèƒ½ resue(å¤ç”¨)çš„çº¿ç¨‹ï¼Œç©ºé—²çš„æ—¶é—´ä¸èƒ½è¶…è¿‡ 60s,ä¸€æ—¦è¶…è¿‡äº† 60s,å°±ä¼šè¢«ç§»å‡ºçº¿ç¨‹æ± 

```java
ExecutorService service2 = Executors.newCacheThreadPool();
```

å›ºå®šå‹çº¿ç¨‹æ± ï¼Œå’Œ newCacheThreadPool()å·®ä¸å¤šï¼Œä¹Ÿèƒ½å¤Ÿå®ç° resue(å¤ç”¨),ä½†æ˜¯è¿™ä¸ªæ± å­è§„å®šäº†çº¿ç¨‹çš„æœ€å¤§æ•°é‡ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æ± å­æœ‰ç©ºé—²æ—¶ï¼Œé‚£ä¹ˆæ–°çš„ä»»åŠ¡å°†ä¼šåœ¨ç©ºé—²çº¿ç¨‹ä¸­è¢«æ‰§è¡Œï¼Œä¸€æ—¦çº¿ç¨‹æ± å†…çš„çº¿ç¨‹éƒ½åœ¨è¿›è¡Œå·¥ä½œï¼Œé‚£ä¹ˆæ–°çš„ä»»åŠ¡å°±å¿…é¡»ç­‰å¾…çº¿ç¨‹æ± æœ‰ç©ºé—²çš„æ—¶å€™æ‰èƒ½å¤Ÿè¿›å…¥çº¿ç¨‹æ± ,å…¶ä»–çš„ä»»åŠ¡ç»§ç»­æ’é˜Ÿç­‰å¾….è¿™ç±»æ± å­æ²¡æœ‰è§„å®šå…¶ç©ºé—²çš„æ—¶é—´åˆ°åº•æœ‰å¤šé•¿.è¿™ä¸€ç±»çš„æ± å­æ›´é€‚ç”¨äºæœåŠ¡å™¨.

```java
ExecutorService service3 = Executors.newFixedThreadPool(10);
```

è°ƒåº¦å‹çº¿ç¨‹æ± ,è°ƒåº¦å‹çº¿ç¨‹æ± ä¼šæ ¹æ® Scheduled(ä»»åŠ¡åˆ—è¡¨)è¿›è¡Œå»¶è¿Ÿæ‰§è¡Œï¼Œæˆ–è€…æ˜¯è¿›è¡Œå‘¨æœŸæ€§çš„æ‰§è¡Œ.é€‚ç”¨äºä¸€äº›å‘¨æœŸæ€§çš„å·¥ä½œ.

```java
public class Test {
    public static void main(String[] args) {
        ExecutorService service = Executors.newCachedThreadPool();
        service.submit(new Runnable() {
            @Override
            public void run() {
                while(true){
                    System.out.println("hello world !");
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        });
        System.out.println(" ===> main Thread execute here ! " );
    }
}

```

```java
ExecutorService service4 = Executors.newScheduledThreadPool(10);
```

### çº¿ç¨‹æ± ä»»åŠ¡åˆ›å»ºä¸æäº¤

ä»»åŠ¡åˆ†ä¸ºä¸¤ç§:ä¸€ç§æ˜¯æœ‰è¿”å›å€¼çš„ï¼ˆ callable ï¼‰ï¼Œä¸€ç§æ˜¯æ²¡æœ‰è¿”å›å€¼çš„ï¼ˆ runnable ï¼‰. Callable ä¸ Future ä¸¤åŠŸèƒ½æ˜¯ Java åœ¨åç»­ç‰ˆæœ¬ä¸­ä¸ºäº†é€‚åº”å¤šå¹¶æ³•æ‰åŠ å…¥çš„ï¼ŒCallable æ˜¯ç±»ä¼¼äº Runnable çš„æ¥å£ï¼Œå®ç° Callable æ¥å£çš„ç±»å’Œå®ç° Runnable çš„ç±»éƒ½æ˜¯å¯è¢«å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚

1. æ— è¿”å›å€¼çš„ä»»åŠ¡å°±æ˜¯ä¸€ä¸ªå®ç°äº† runnable æ¥å£çš„ç±».ä½¿ç”¨ run æ–¹æ³•.
1. æœ‰è¿”å›å€¼çš„ä»»åŠ¡æ˜¯ä¸€ä¸ªå®ç°äº† callable æ¥å£çš„ç±».ä½¿ç”¨ call æ–¹æ³•.

Callable å’Œ Runnable çš„åŒºåˆ«å¦‚ä¸‹ï¼š

1. Callable å®šä¹‰çš„æ–¹æ³•æ˜¯ callï¼Œè€Œ Runnable å®šä¹‰çš„æ–¹æ³•æ˜¯ runã€‚
1. Callable çš„ call æ–¹æ³•å¯ä»¥æœ‰è¿”å›å€¼ï¼Œè€Œ Runnable çš„ run æ–¹æ³•ä¸èƒ½æœ‰è¿”å›å€¼ã€‚
1. Callable çš„ call æ–¹æ³•å¯æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ Runnable çš„ run æ–¹æ³•ä¸èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚

execute ä¸ submit åŒºåˆ«ï¼š

1. æ¥æ”¶çš„å‚æ•°ä¸ä¸€æ ·
1. submit æœ‰è¿”å›å€¼ï¼Œè€Œ execute æ²¡æœ‰
1. submit æ–¹ä¾¿ Exception å¤„ç†
1. execute æ˜¯ Executor æ¥å£ä¸­å”¯ä¸€å®šä¹‰çš„æ–¹æ³•ï¼›submit æ˜¯ ExecutorServiceï¼ˆè¯¥æ¥å£ç»§æ‰¿ Executorï¼‰ä¸­å®šä¹‰çš„æ–¹æ³•

### çº¿ç¨‹æ± çš„å…³é—­

æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨çº¿ç¨‹æ± çš„ shutdown æˆ– shutdownNow æ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± ï¼Œä½†æ˜¯å®ƒä»¬çš„å®ç°åŸç†ä¸åŒï¼Œshutdown çš„åŸç†æ˜¯åªæ˜¯å°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®æˆ SHUTDOWN çŠ¶æ€ï¼Œç„¶åä¸­æ–­æ‰€æœ‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ã€‚shutdownNow çš„åŸç†æ˜¯éå†çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œç„¶åé€ä¸ªè°ƒç”¨çº¿ç¨‹çš„ interrupt æ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹ï¼Œæ‰€ä»¥æ— æ³•å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢ã€‚shutdownNow ä¼šé¦–å…ˆå°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®æˆ STOPï¼Œç„¶åå°è¯•åœæ­¢æ‰€æœ‰çš„æ­£åœ¨æ‰§è¡Œæˆ–æš‚åœä»»åŠ¡çš„çº¿ç¨‹ï¼Œå¹¶è¿”å›ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„åˆ—è¡¨ã€‚

åªè¦è°ƒç”¨äº†è¿™ä¸¤ä¸ªå…³é—­æ–¹æ³•çš„å…¶ä¸­ä¸€ä¸ªï¼ŒisShutdown æ–¹æ³•å°±ä¼šè¿”å› trueã€‚å½“æ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²å…³é—­å,æ‰è¡¨ç¤ºçº¿ç¨‹æ± å…³é—­æˆåŠŸï¼Œè¿™æ—¶è°ƒç”¨ isTerminaed æ–¹æ³•ä¼šè¿”å› trueã€‚è‡³äºæˆ‘ä»¬åº”è¯¥è°ƒç”¨å“ªä¸€ç§æ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± ï¼Œåº”è¯¥ç”±æäº¤åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡ç‰¹æ€§å†³å®šï¼Œé€šå¸¸è°ƒç”¨ shutdown æ¥å…³é—­çº¿ç¨‹æ± ï¼Œå¦‚æœä»»åŠ¡ä¸ä¸€å®šè¦æ‰§è¡Œå®Œï¼Œåˆ™å¯ä»¥è°ƒç”¨ shutdownNowã€‚

### çº¿ç¨‹æ± çš„åˆ†æ

#### çº¿ç¨‹æ± åˆ›å»ºåˆ†æ

```java
new ThreadPoolExecutor(corePoolSize, maximumPoolSize,
keepAliveTime, milliseconds,runnableTaskQueue, threadFactory,handler);
```

åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± éœ€è¦è¾“å…¥å‡ ä¸ªå‚æ•°ï¼š

- corePoolSizeï¼ˆçº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼‰ï¼šå½“æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå³ä½¿å…¶ä»–ç©ºé—²çš„åŸºæœ¬çº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œæ–°ä»»åŠ¡ä¹Ÿä¼šåˆ›å»ºçº¿ç¨‹ï¼Œç­‰åˆ°éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°å¤§äºçº¿ç¨‹æ± åŸºæœ¬å¤§å°æ—¶å°±ä¸å†åˆ›å»ºã€‚å¦‚æœè°ƒç”¨äº†çº¿ç¨‹æ± çš„ prestartAllCoreThreads æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰åŸºæœ¬çº¿ç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º 0ï¼Œå½“æœ‰ä»»åŠ¡æ¥ä¹‹åï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ° corePoolSize åï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„ä»»åŠ¡æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—å½“ä¸­ï¼›
- runnableTaskQueueï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼šç”¨äºä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ã€‚å¯ä»¥é€‰æ‹©ä»¥ä¸‹å‡ ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚

1. ArrayBlockingQueueï¼šæ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚
1. LinkedBlockingQueueï¼šä¸€ä¸ªåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰ FIFO ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ æ’åºå…ƒç´ ï¼Œååé‡é€šå¸¸è¦é«˜äº ArrayBlockingQueueã€‚é™æ€å·¥å‚æ–¹æ³• Executors.newFixedThreadPool()ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚
1. SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äº LinkedBlockingQueueï¼Œé™æ€å·¥å‚æ–¹æ³• Executors.newCachedThreadPool ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚
1. PriorityBlockingQueueï¼šä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§å¾—æ— é™é˜»å¡é˜Ÿåˆ—ã€‚

- maximumPoolSizeï¼ˆçº¿ç¨‹æ± æœ€å¤§å¤§å°ï¼‰ï¼šçº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”å·²åˆ›å»ºçš„çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™çº¿ç¨‹æ± ä¼šå†åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯å¦‚æœä½¿ç”¨äº†æ— ç•Œçš„ä»»åŠ¡é˜Ÿåˆ—è¿™ä¸ªå‚æ•°å°±æ²¡ä»€ä¹ˆæ•ˆæœã€‚ä¹Ÿå°±æ˜¯è¯´ corePoolSize å°±æ˜¯çº¿ç¨‹æ± å¤§å°ï¼ŒmaximumPoolSize åœ¨æˆ‘çœ‹æ¥æ˜¯çº¿ç¨‹æ± çš„ä¸€ç§è¡¥æ•‘æªæ–½ï¼Œå³ä»»åŠ¡é‡çªç„¶è¿‡å¤§æ—¶çš„ä¸€ç§è¡¥æ•‘æªæ–½ã€‚
- ThreadFactoryï¼šç”¨äºè®¾ç½®åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹å·¥å‚ç»™æ¯ä¸ªåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹è®¾ç½®æ›´æœ‰æ„ä¹‰çš„åå­—ï¼ŒDebug å’Œå®šä½é—®é¢˜æ—¶éå¸¸åˆå¸®åŠ©ã€‚
- RejectedExecutionHandlerï¼ˆé¥±å’Œç­–ç•¥ï¼‰ï¼šå½“é˜Ÿåˆ—å’Œçº¿ç¨‹æ± éƒ½æ»¡äº†ï¼Œè¯´æ˜çº¿ç¨‹æ± å¤„äºé¥±å’ŒçŠ¶æ€ï¼Œé‚£ä¹ˆå¿…é¡»é‡‡å–ä¸€ç§ç­–ç•¥å¤„ç†æäº¤çš„æ–°ä»»åŠ¡ã€‚è¿™ä¸ªç­–ç•¥é»˜è®¤æƒ…å†µä¸‹æ˜¯ AbortPolicyï¼Œè¡¨ç¤ºæ— æ³•å¤„ç†æ–°ä»»åŠ¡æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚ä»¥ä¸‹æ˜¯ JDK1.5 æä¾›çš„å››ç§ç­–ç•¥ã€‚

1. AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸
1. CallerRunsPolicyï¼šåªç”¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡ã€‚
1. DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—é‡Œæœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ã€‚
1. DiscardPolicyï¼šä¸å¤„ç†ï¼Œä¸¢å¼ƒæ‰ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯éœ€è¦æ¥å®ç° RejectedExecutionHandler æ¥å£è‡ªå®šä¹‰ç­–ç•¥ã€‚å¦‚è®°å½•æ—¥å¿—æˆ–æŒä¹…åŒ–ä¸èƒ½å¤„ç†çš„ä»»åŠ¡ã€‚

- keepAliveTimeï¼ˆçº¿ç¨‹æ´»åŠ¨ä¿æŒæ—¶é—´ï¼‰ï¼šçº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ç©ºé—²åï¼Œä¿æŒå­˜æ´»çš„æ—¶é—´ã€‚æ‰€ä»¥å¦‚æœä»»åŠ¡å¾ˆå¤šï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œå¯ä»¥è°ƒå¤§è¿™ä¸ªæ—¶é—´ï¼Œæé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡ã€‚
- TimeUnitï¼ˆçº¿ç¨‹æ´»åŠ¨ä¿æŒæ—¶é—´çš„å•ä½ï¼‰ï¼šå¯é€‰çš„å•ä½æœ‰å¤©ï¼ˆDAYSï¼‰ï¼Œå°æ—¶ï¼ˆHOURSï¼‰ï¼Œåˆ†é’Ÿï¼ˆMINUTESï¼‰ï¼Œæ¯«ç§’(MILLISECONDS)ï¼Œå¾®ç§’(MICROSECONDS, åƒåˆ†ä¹‹ä¸€æ¯«ç§’)å’Œæ¯«å¾®ç§’(NANOSECONDS, åƒåˆ†ä¹‹ä¸€å¾®ç§’)ã€‚

![](https://cdn.jsdelivr.net/gh/mafulong/mdPic@vv6/v6/202505041121762.jpeg)

ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå½“æäº¤ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œçº¿ç¨‹æ± çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š

1. å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®å°äº corePoolSizeï¼Œåˆ™æ¯æ¥ä¸€ä¸ªä»»åŠ¡ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼›
1. å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®>=corePoolSizeï¼Œåˆ™æ¯æ¥ä¸€ä¸ªä»»åŠ¡ï¼Œä¼šå°è¯•å°†å…¶æ·»åŠ åˆ°ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—å½“ä¸­ï¼Œè‹¥æ·»åŠ æˆåŠŸï¼Œåˆ™è¯¥ä»»åŠ¡ä¼šç­‰å¾…ç©ºé—²çº¿ç¨‹å°†å…¶å–å‡ºå»æ‰§è¡Œï¼›è‹¥æ·»åŠ å¤±è´¥ï¼ˆä¸€èˆ¬æ¥è¯´æ˜¯ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—å·²æ»¡ï¼‰ï¼Œåˆ™ä¼šå°è¯•åˆ›å»ºæ–°çš„çº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼›
1. å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ° maximumPoolSizeï¼Œåˆ™ä¼šé‡‡å–ä»»åŠ¡æ‹’ç»ç­–ç•¥è¿›è¡Œå¤„ç†ï¼›

å¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº corePoolSize æ—¶ï¼Œå¦‚æœæŸçº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTimeï¼Œçº¿ç¨‹å°†è¢«ç»ˆæ­¢ï¼Œç›´è‡³çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®ä¸å¤§äº corePoolSizeï¼›å¦‚æœå…è®¸ä¸ºæ ¸å¿ƒæ± ä¸­çš„çº¿ç¨‹è®¾ç½®å­˜æ´»æ—¶é—´ï¼Œé‚£ä¹ˆæ ¸å¿ƒæ± ä¸­çš„çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTimeï¼Œçº¿ç¨‹ä¹Ÿä¼šè¢«ç»ˆæ­¢

ä»å®ƒä»¬çš„å…·ä½“å®ç°æ¥çœ‹ï¼Œå®ƒä»¬å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨äº† ThreadPoolExecutorï¼Œåªä¸è¿‡å‚æ•°éƒ½å·²é…ç½®å¥½äº†ã€‚

newFixedThreadPool åˆ›å»ºçš„çº¿ç¨‹æ±  corePoolSize å’Œ maximumPoolSize å€¼æ˜¯ç›¸ç­‰çš„ï¼Œå®ƒä½¿ç”¨çš„ LinkedBlockingQueueï¼›

newSingleThreadExecutor å°† corePoolSize å’Œ maximumPoolSize éƒ½è®¾ç½®ä¸º 1ï¼Œä¹Ÿä½¿ç”¨çš„ LinkedBlockingQueueï¼›

newCachedThreadPool å°† corePoolSize è®¾ç½®ä¸º 0ï¼Œå°† maximumPoolSize è®¾ç½®ä¸º Integer.MAX_VALUEï¼Œä½¿ç”¨çš„ SynchronousQueueï¼Œä¹Ÿå°±æ˜¯è¯´æ¥äº†ä»»åŠ¡å°±åˆ›å»ºçº¿ç¨‹è¿è¡Œï¼Œå½“çº¿ç¨‹ç©ºé—²è¶…è¿‡ 60 ç§’ï¼Œå°±é”€æ¯çº¿ç¨‹ã€‚

å®é™…ä¸­ï¼Œå¦‚æœ Executors æä¾›çš„ä¸‰ä¸ªé™æ€æ–¹æ³•èƒ½æ»¡è¶³è¦æ±‚ï¼Œå°±å°½é‡ä½¿ç”¨å®ƒæä¾›çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œå› ä¸ºè‡ªå·±å»æ‰‹åŠ¨é…ç½® ThreadPoolExecutor çš„å‚æ•°æœ‰ç‚¹éº»çƒ¦ï¼Œè¦æ ¹æ®å®é™…ä»»åŠ¡çš„ç±»å‹å’Œæ•°é‡æ¥è¿›è¡Œé…ç½®ã€‚å¦å¤–ï¼Œå¦‚æœ ThreadPoolExecutor è¾¾ä¸åˆ°è¦æ±‚ï¼Œå¯ä»¥è‡ªå·±ç»§æ‰¿ ThreadPoolExecutor ç±»è¿›è¡Œé‡å†™ã€‚

## AQSåŸç†

> AQSï¼ˆAbstractQueuedSynchronizerï¼‰çš„åŸç†ã€‚å®ƒæ˜¯ Java å¹¶å‘æ¡†æ¶ä¸­ç”¨äºæ„å»ºé”å’ŒåŒæ­¥å™¨çš„ä¸€ä¸ªæ ¸å¿ƒæ¡†æ¶ç±»ï¼Œæ¯”å¦‚ ReentrantLockã€Semaphoreã€CountDownLatch ç­‰åŒæ­¥å™¨ï¼Œåº•å±‚éƒ½æ˜¯åŸºäº AQS å®ç°çš„ã€‚æ˜¯ Java å¹¶å‘åŒ… `java.util.concurrent.locks` ä¸­ç”¨æ¥æ„å»ºé”å’Œå…¶ä»–åŒæ­¥å™¨ï¼ˆå¦‚ä¿¡å·é‡ã€è¯»å†™é”ã€å€’è®¡æ—¶å™¨ç­‰ï¼‰çš„ä¸€ä¸ª**åŸºç¡€æ¡†æ¶ç±»**ã€‚å®ƒæ˜¯ J.U.C å¹¶å‘æ¡†æ¶ä¸­æœ€æ ¸å¿ƒçš„åº•å±‚ç»„ä»¶ä¹‹ä¸€ã€‚



AQS é€šè¿‡ä¸€ä¸ª**FIFO é˜Ÿåˆ—**ï¼ˆå…ˆè¿›å…ˆå‡ºç­‰å¾…é˜Ÿåˆ—ï¼‰æ¥**ç®¡ç†è·å–é”å¤±è´¥çš„çº¿ç¨‹**ï¼Œå¹¶é€šè¿‡ä¸€ä¸ª**åŸå­å˜é‡ state** æ¥**è¡¨ç¤ºåŒæ­¥çŠ¶æ€**ï¼Œä»è€Œå®ç°å„ç§è‡ªå®šä¹‰åŒæ­¥å™¨ã€‚

#### ğŸŒŸ 1. æ ¸å¿ƒæ€æƒ³ï¼šçŠ¶æ€ + é˜Ÿåˆ—

AQS çš„æ ¸å¿ƒæ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼š

- **state**ï¼šä¸€ä¸ª `volatile int state` è¡¨ç¤ºå½“å‰çš„åŒæ­¥çŠ¶æ€ï¼Œæ¯”å¦‚ 0 è¡¨ç¤ºæœªåŠ é”ï¼Œ1 è¡¨ç¤ºå·²åŠ é”ã€‚
- **ç­‰å¾…é˜Ÿåˆ—ï¼ˆCLH é˜Ÿåˆ—ï¼‰**ï¼šçº¿ç¨‹è·å–é”å¤±è´¥åï¼Œä¼šè¢«å°è£…ä¸ºä¸€ä¸ª `Node` èŠ‚ç‚¹ï¼ŒåŠ å…¥åˆ°ä¸€ä¸ª **FIFO åŒå‘é˜Ÿåˆ—** ä¸­ï¼Œå¹¶é€šè¿‡ `LockSupport.park()` æŒ‚èµ·ã€‚

#### ğŸ” 2. è·å–é”æµç¨‹ï¼ˆä»¥ç‹¬å ä¸ºä¾‹ï¼‰ï¼š

- çº¿ç¨‹è°ƒç”¨ `acquire()` å°è¯•åŠ é”ï¼Œåº•å±‚ä¼šè°ƒç”¨ `tryAcquire()`ã€‚
- å¦‚æœ `tryAcquire()` å¤±è´¥ï¼Œå°±è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶é˜»å¡å½“å‰çº¿ç¨‹ã€‚
- å‰ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”æ—¶è°ƒç”¨ `release()`ï¼Œåº•å±‚è°ƒç”¨ `tryRelease()` æˆåŠŸåå”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹ã€‚

#### ğŸ§± 3. AQS æä¾›æ¨¡æ¿æ–¹æ³•ï¼Œå­ç±»è´Ÿè´£å®ç°ï¼š

```

protected boolean tryAcquire(int arg);
protected boolean tryRelease(int arg);
```

å¼€å‘è€…é€šè¿‡ç»§æ‰¿ AQS å¹¶å®ç°è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥è‡ªå®šä¹‰åŒæ­¥å™¨çš„è¡Œä¸ºã€‚

#### ğŸ“Œ 4. æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

- **ç‹¬å æ¨¡å¼ï¼ˆExclusiveï¼‰**ï¼šä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–èµ„æºï¼Œå¦‚ ReentrantLockã€‚
- **å…±äº«æ¨¡å¼ï¼ˆSharedï¼‰**ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«èµ„æºï¼Œå¦‚ Semaphoreã€CountDownLatchã€‚

#### ğŸ“š 5. å®é™…åº”ç”¨ä¸¾ä¾‹ï¼š

- ReentrantLockï¼šåŸºäº AQS çš„ç‹¬å æ¨¡å¼ã€‚
- Semaphoreï¼šåŸºäºå…±äº«æ¨¡å¼æ§åˆ¶å¹¶å‘æ•°é‡ã€‚
- CountDownLatchï¼šé€šè¿‡å…±äº«è®¡æ•°æ§åˆ¶çº¿ç¨‹ç­‰å¾…ã€‚



Java ä¸­å¾ˆå¤šåŒæ­¥å™¨éƒ½æ˜¯åŸºäº AQS å®ç°çš„ï¼š

| åŒæ­¥å™¨                     | ä½¿ç”¨ AQS æ¨¡å¼  |
| -------------------------- | -------------- |
| ReentrantLock              | ç‹¬å            |
| Semaphore                  | å…±äº«           |
| CountDownLatch             | å…±äº«           |
| ReentrantReadWriteLock     | è¯»å…±äº«ï¼Œå†™ç‹¬å  |
| AbstractQueuedSynchronizer | è‡ªå®šä¹‰æ‰©å±•     |