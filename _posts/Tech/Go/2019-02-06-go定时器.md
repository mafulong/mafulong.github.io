---
layout: post
category: Go
title: go定时器
---
results保存数据

sync.RWMutex解决并发

开个协程，for循环，select

时间使用time.Tick(Data.t)信道

```go
type Data struct {
	results []model.Data
	lock    *sync.RWMutex
	t       time.Duration
	close   chan int
}

const CAP = 100
const FLUSH_DURATION_SECONDS = 30

var (
	DataInstance *Data
)

func NewData(t time.Duration) *Data {
	if t <= FLUSH_DURATION_SECONDS*time.Second {
		t = FLUSH_DURATION_SECONDS * time.Second
	}
	tempObj := &Data{
		results: make([]model.Data, 0, CAP),
		lock:    new(sync.RWMutex),
		t:       t,
		close:   make(chan int, 1),
	}
	return tempObj
}

func (Data *Data) Start() {
	Data.flushData()
	timer := time.Tick(Data.t)
	go func() {
		for {
			select {
			case <-timer:
				Data.flushData()
			case <-Data.close:
				break
			}
		}
	}()
}

func (Data *Data) Close() {
	Data.close <- 1
}

func (Data *Data) flushData() {
    //db写到tempResults
	Data.lock.Lock()
	defer Data.lock.Unlock()
	Data.results = tempResults
	return
}

func (Data *Data) GetData() []model.Data {
	tempResults := make([]model.Data, 0, CAP)
	Data.lock.RLock()
	defer Data.lock.RUnlock()
	for _, t := range Data.results {
		tempResults = append(tempResults, t)
	}
	return tempResults
}

func GetDataData() []model.Data {
	return DataInstance.GetData()
}

func FlushData() {
	DataInstance.flushData()
}
func CloseFlushData() {
	DataInstance.Close()
}

func init() {
	DataInstance = NewData(FLUSH_DURATION_SECONDS * time.Second)
	DataInstance.Start()
}

```